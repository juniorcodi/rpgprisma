<!DOCTYPE html>

<html>
<head><script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script><script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
<meta charset="utf-8"/>
<title>RPG Arena</title>
<style>
body { background: #0F0F0F; color: whitesmoke;}

	.twocell-table { width:100%; table-layout: fixed;}

	.char-block { width:100%; min-width: 420px; }

	.action-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }

	input, textarea { background: #191919; color: #fff; border: 1px solid #555; }

	table, th, td {
		border: none;
		
	}
	div {
		border-radius: 4px;
	}

	select {
		background-color: inherit;
		border-radius: 4px;
				
		.option {
			font-family: 'Faculty Glyphic';
			background-color: #222;
			font-size: 16px;
			color: whitesmoke;
			
		}
	}

  h2 {
    font-size: 24px;
    text-align: center;
    font-family: 'Nova Flat';
    font-weight: bold;
    
  }
		@font-face {
  		font-family: "NotoEmoji";
  		src: url("https://fonts.fonts.gstatic.com/s/notoemoji/v/latest/NotoEmoji-Regular.ttf") format("truetype");
  		unicode-range: U+1F000-1FAFF; /* Emoji block */
	}

.emoji {
  font-family: "NotoEmoji", sans-serif !important;
}
	
	.setup-row { display: flex; gap: 24px; margin-bottom: 18px; justify-content: center; }

	.separated {
	display: flex;
	justify-content: space-between;
	margin-bottom: 3px;
	font-family: 'Faculty Glyphic';
}
	
    .slider-set {
      width: 340px;
      font-size: 15px;
      margin: auto;
	  padding-left: 16px;
    }


    .slider-container {
      position: relative;
      width: 100%;
      margin-bottom: 9.5px;
	    }

    .slider {
      width: 100%;
      appearance: none;
      height: 5px;
      border-radius: 0;
      outline: none;
      z-index: 2;
      position: relative;
	  border: none;
      background-color: #222;
	}
	
	.slider-top {
	  width: 100%;
      appearance: none;
      height: 5px;
      border-radius: 0;
      outline: none;
      z-index: 2;
      position: relative;
	  border: none;
      background-color: #222;
	}

    .slider::-webkit-slider-thumb  {
      appearance: none;
      width: 10px;
      height: 10px;
      background: whitesmoke;
      cursor: pointer;
      border: none;
      margin-top: -2px;
      position: relative;
      z-index: 3;
	  opacity: 1%; 
    }

	.slider-top::-webkit-slider-thumb  {
      appearance: none;
      width: 10px;
      height: 10px;
      background: whitesmoke;
      cursor: pointer;
      border: none;
      margin-top: -2px;
      position: relative;
      z-index: 3;
	  opacity: 1%; 
    }
	
	.hp-slider-fill {
  background: linear-gradient(to right, crimson 0%, crimson 50%, #333 50%, #333 100%);
}

	.energy-slider-fill {
  background: linear-gradient(to right, #FDA528 0%, #FDA528 50%, #333 50%, #333 100%);
}
	
	.nova-flat-regular {
  		font-family: "Nova Flat", system-ui;
 		font-weight: 400;
  		font-style: normal;
}
	  
    .char-name {
      font-size: 32px;
      font-family: 'Nova Flat', sans-serif;
      font-weight: bold;
      color: whitesmoke;
	  padding: 10px;

    }

    .atr-num-ins {
      background-color: #B73D11;
      font-size: 40px;
      font-family: 'Nova Flat', sans-serif;
      font-weight: bold;
      color: #ffb22e;
      text-align: center;
	  border-radius: 4px;
    }

    .atr-num-sim {
      background-color: #aa1e57;
      font-size: 40px;
      font-family: 'Nova Flat', sans-serif;
      font-weight: bold;
      color: #ef8ec0;
      text-align: center;
		border-radius: 4px;
    }

    .atr-num-raz {
      background-color: #423682;
      font-size: 40px;
      font-family: 'Nova Flat', sans-serif;
      font-weight: bold;
      color: #bfa6ff;
      text-align: center;
		border-radius: 4px;
    }

    .atr-num-mal {
      background-color: #08626D;
      font-size: 40px;
      font-family: 'Nova Flat', sans-serif;
      font-weight: bold;
      color: #46bdc6;
      text-align: center;
		border-radius: 4px;
    }

    .atr {
      font-family: 'Faculty Glyphic', serif;
      text-align: center;
      font-size: 16px;
      color: whitesmoke;
    }

    .atr-num-none {
	  background-color: #222;
      font-size: 36px;
      font-family: 'Nova Flat', sans-serif;
      font-weight: bold;
      color: whitesmoke;
      text-align: center;
		border-radius: 4px;
    }

    .text-hp,
    .text-energy {
      font-size: 16px;
      font-family: 'Nova Flat', sans-serif;
      font-weight: normal;
      color: whitesmoke;
      text-align: center;
    }

    .minititle {
      font-size: 14px;
      font-family: 'Faculty Glyphic', serif;
      text-align: center;
      color: whitesmoke;
    }
	
.cond-obs {
  font-size: 15px;
  font-family: 'Faculty Glyphic', serif;
  color: whitesmoke;
  text-align: center;
  border-radius: 4px;
  background-color: transparent;
  border: none;
  outline: none;
  transition: all 0.3s ease;
}

/* When hovered */
.cond-obs:hover {
  background-color: rgba(255, 255, 255, 0.05); /* subtle highlight */
}

/* When focused (user clicked or is typing) */
.cond-obs:focus {
  border: 1px solid #aaa;
  background-color: rgba(255, 255, 255, 0.08);
}

/* When filled (not empty) */
.cond-obs.filled {
  border: none;
}

	.autocomplete-suggestions div:hover {
  background: #333;
}
	
    .alt-tip {
      background-color: #212f3d;
      color: whitesmoke;
      font-family: 'Faculty Glyphic', serif;
      text-align: center;
      width: 250px;
      border-radius: 4px;
      border: 1px solid whitesmoke;
      padding: 5px;
    }

.button {
  background-color: #222;
  font-size: 15px;
  font-family: 'Faculty Glyphic';
  color: whitesmoke;
  text-align: center;
  border-radius: 4px;
  border: none;
  padding: 5px 10px;
  cursor: pointer;

  transition: background-color 0.2s ease, transform 0.1s ease;
}

.button:hover {
  background-color: #333; /* slightly lighter */
}

.button:active {
  transform: scale(0.96); /* click effect */
}

    .cover-img,
    .img {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .span-ins, .span-sim, .span-raz, .span-mal, .span-none {
      font-size: 10px;
      height: 12px;
      font-family: 'Nova Flat', sans-serif;
      font-weight: bold;
      text-transform: uppercase;
      border-radius: 3px;
      padding: 2px 6px;
      color: white;
      display: flex; flex-wrap: wrap; gap: 6px;
    }

    .span-ins { background-color: #FD7B1F; }
    .span-sim { background-color: #FD42B9; }
    .span-raz { background-color: #856CFC; }
    .span-mal { background-color: #1BC4DA; }
    .span-none { background-color: #616161; }

    /* Classes dinâmicas para elementos com IFs serão sugeridas com sufixos, por exemplo: .text-variable.sim, .text-variable.raz etc */
    .text-variable {
      font-size: 20px;
      font-family: 'Nova Flat', sans-serif;
      font-weight: bold;
      text-align: center;
    }
    .text-variable.ins { color: #FEDDBD; }
    .text-variable.sim { color: #FECDEB; }
    .text-variable.raz { color: #DFD7FE; }
    .text-variable.mal { color: #BDEFF5; }
    .text-variable.none { color: #CECECE; }
	
	.text-variable-emoji {
      font-size: 28px;
      font-family: "NotoEmoji", sans-serif, !important;
      text-align: center;
	}
	.text-variable-emoji.ins { color: #FEDDBD;}
    .text-variable-emoji.sim { color: #FECDEB; }
    .text-variable-emoji.raz { color: #DFD7FE; }
    .text-variable-emoji.mal { color: #BDEFF5; }
    .text-variable-emoji.none { color: #CECECE; }
	
	

	.title {
	  font-size: 14px;
      font-family: 'Faculty Glyphic', serif;
      text-align: center;
      color: whitesmoke;
	  padding: 5px;	  
	  
	}
	.action-variable{
		font-size: 15px;
		text-align: center;
		align-content: center;
		font-family: 'Nova Flat';
		font-weight: 400;	
		
	}
	.action-variable.ins { color: #FD7B1F;}     
	.action-variable.sim { color: #FD42B9;  !important;}
	.action-variable.raz { color: #856CFC;}
	.action-variable.mal { color: #1BC4DA;}
	.action-variable.none { color: #AAA;}
	
    .title-variable {
      font-size: 32px;
      font-family: 'Nova Flat', sans-serif;
      font-weight: bold;
      text-align: center;
    }
    .title-variable.ins { color: #99330C; }
    .title-variable.sim { color: #961A4E; }
    .title-variable.raz { color: #392C78; }
    .title-variable.mal { color: #05525B; }
	.title-variable.none { color: #151515; }

    .sub-variable {
      font-size: 10px;
      font-family: 'Nova Flat', sans-serif;
      text-align: center;
    }
    .sub-variable.ins { color: #FDA528; }
    .sub-variable.sim { color: #FE5FD0; }
    .sub-variable.raz { color: #AD91FD; }
    .sub-variable.mal { color: #23D8E7; }
    .sub-variable.none { color: darkgray; }

    .strong-variable {
      font-size: 12px;
      font-family: 'Faculty Glyphic', serif;
      text-align: center;
	  flex-wrap: wrap;
		
    }
    .strong-variable.ins { color: #FEDDBD; }
    .strong-variable.sim { color: #FECDEB; }
    .strong-variable.raz { color: #DFD7FE; }
    .strong-variable.mal { color: #BDEFF5; }
    .strong-variable.none { color: whitesmoke; }

    .descr-variable {
      font-size: 14px;
      font-family: 'Faculty Glyphic', serif;
      font-weight: bold;
      text-align: center;
    }
    .descr-variable.ins { color: #99330C; !important }         
    .descr-variable.sim { color: #961A4E; !important }
    .descr-variable.raz { color: #392C78; !important }
    .descr-variable.mal { color: #05525B; !important }
    .descr-variable.none { color: #1E1E1E; !important }

    .back-variable.ins { background-color: #B73D11; }
    .back-variable.sim { background-color: #aa1e57; }
    .back-variable.raz { background-color: #423682; }
    .back-variable.mal { background-color: #08626D; }
    .back-variable.none { background-color: #222; }

	.light-div.ins { background-color: #FDA528; }
    .light-div.sim { background-color: #FECDEB; }
    .light-div.raz { background-color: #DFD7FE; }
    .light-div.mal { background-color: #BDEFF5; }
    .light-div.none { background-color: #888; }

    .dark-div.ins { background-color: #99330C; }
    .dark-div.sim { background-color: #961A4E; }
    .dark-div.raz { background-color: #392C78; }
    .dark-div.mal { background-color: #05525B; }
    .dark-div.none { background-color: #1E1E1E; }	
	
	.frame{
		padding: 12px;
		border: 0px solid #555;
		background-color: #222;

	}
	
	/* Right edge cells: show background gap on the right */
.right-gap {
  padding-right: 8px;         /* creates visual gap */
  background-clip: padding-box;
  background-color: inherit;
  background-clip: padding-box;
  border-right: 12px solid transparent;
	}

/* Bottom edge cells: show background gap at the bottom */
.bottom-gap {
  padding-bottom: 8px;
  background-clip: padding-box;
  background-color: inherit;
  background-clip: padding-box;
  border-bottom: 12px solid transparent;
}
	.roll-section {
		table-layout:fixed;
		text-align: center;
		margin-top: 16px;
		background: #151515;
		border-radius: 4px;
		padding: 10px;
		font-family: 'Nova Flat';
		font-size: 20px;
	}
	.roll-formula {
		background: #222;
		padding: 5px;
		padding-left: 14px;
		padding-right: 14px;
		border-radius: 4px;
		font-family: 'Faculty Glyphic';
		font-size: 16px; !important ;
		
	}
	.action-block {
		color: white;
		border-radius: 3px;
		padding: 4px;
		padding-left: 8px;
		padding-right: 8px;
		font-size: 14px;
    cursor: pointer;
    user-select: none;
	}
	
	.action-block.ins { background-color: tomato; }
	.action-block.sim { background-color: deeppink; }
	.action-block.raz { background-color: rebeccapurple; }
	.action-block.mal { background-color: teal; }
	.action-block.none { background-color: #111; }
	
	.individual-result {
		font-size: 18px;
		background: blue;
		padding: 5px;
	}
	.partial-result {
		background: yellow;
	}
	.special-dice-box {
		border: solid 2px gray;
		background: fuchsia;
	}
	.dice-select-block {
		padding: 7px;
		display: flex;
  		flex-direction: column;
  		align-items: center;
		text-align: center;
		vertical-align: center;
	}
	
	.dice-rolling-line {
		display: inline-flex;
		align-items: center;
		padding: 10px;
		gap: 10px;
		
	}
.top-toolbar {
  display: flex;
  justify-content: center;
  gap: 10px;
  background-color: #111;
  padding: 10px 0;
  border-bottom: 1px solid #444;
  position: sticky;
  top: 0;
  z-index: 999;
  margin-bottom: 20px;
}

.top-button {
  font-size: 20px;
  background: #222;
  color: white;
  border: 1px solid #444;
  border-radius: 4px;
  padding: 6px 10px;
  cursor: pointer;
  transition: background 0.3s ease;
}

.top-button:hover {
  background-color: #333;
}
	
 #event-log-toolbar {
    margin-bottom: 8px;
    background: #222;
    padding: 6px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    font-family: sans-serif;
  }

  #event-log-container {
    max-height: 500px;
    overflow-y: auto;
    background: #222;
    border-radius: 6px;
    padding: 10px;
    font-family: sans-serif;
  }

  .log-entry {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    background: #333;
    padding: 6px;
    border-radius: 4px;
    margin-bottom: 6px;
    border-left: 5px solid #ddd;
  }

  .log-entry .log-content {
    flex-grow: 1;
    font-size: 14px;
    white-space: pre-wrap;
  }

  .log-entry textarea {
    width: 100%;
    min-height: 60px;
  }

  .log-entry input[type="checkbox"] {
    margin-top: 6px;
  }

  .log-entry .log-status {
    margin-top: 6px;
  }

  .hidden-log {
    display: none;
  }
	
	#spells-area {
  padding: 10px;
  border: 1px solid #444;
  margin-top: 6px;
}
 .spell-container {
  margin-top: 15px;
  margin-bottom: 15px;
  display: flex;
  width: fit-content;
    
}
.spell-side {
  background: #1b1b1b;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #444;
}
	
	.spells-action-container span {
	display: inline-block;   /* ou inline-flex */
  margin: 0 4px;	
	}
	
</style>

</head>
<body>
<div id="save-indicator" style="
  position: fixed;
  top: 12px;
  right: 16px;
  background: #222;
  padding: 8px 12px;
  font-size: 16px;
  font-family: 'Nova Flat', sans-serif;
  color: white;
  border: 1px solid #555;
  border-radius: 6px;
  z-index: 9999;
  box-shadow: 0 0 8px rgba(0,0,0,0.3);
">☁️ Aguardando...</div>
<div class="top-toolbar" id="top-bar">
<button class="top-button" id="toggle-spells" onclick="toggleSpellSection()" title="Feitiços">🪄</button>
<button class="top-button" id="calculator-button" onclick="window.open('difficulty_calculator.html', 'CalculadoraDeDificuldade', 'width=1000,height=700,resizable=yes,scrollbars=yes')" title="Calculadora de Dificuldade">🧮</button>
<button class="top-button" title="Relacionamentos">💞</button>
<button class="top-button" title="Aprendizados">📚</button>
<button class="top-button" onclick="window.open('uso_ambiente.html', 'UsoDoAmbiente', 'width=1000,height=700,resizable=yes,scrollbars=yes')" title="Uso do ambiente">🌎</button>
<button class="top-button" title="Inventário">🎒</button>
<button class="top-button" title="Filtro de Ações">❓</button>
</div>
<center><div class="spell-container" id="spells-area">
<div style="display: grid; grid-template-columns: 880px 880px; gap: 30px; justify-content: center;">
<!-- Lado A -->
<div class="spell-side" id="spells-a" style="flex: 1;"></div>
<!-- Lado B -->
<div class="spell-side" id="spells-b" style="flex: 1;"></div>
</div>
</div></center>
<!-- Script para autocomplete e preenchimento -->
<script>   
	  
  function toggleSpellSection() {
  const spellArea = document.getElementById("spells-area");
  if (!spellArea) return; // Previne erro se ainda não existe
  spellArea.style.display = spellArea.style.display === "none" ? "flex" : "none";
}
    let spellsData = [];
    let spellsList = [];

    // Fetch CSV
     => {
        spellsData = results.data;
        spellsList = spellsData.map(s => s.spell_name);
        buildSpellsTables(); // após carregar, constrói as tabelas
      }
    });

    // Constrói as tabelas mágicas A e B
    function buildSpellsTables() {
      ["a", "b"].forEach(side => {
        const container = document.getElementById(`spells-${side}`);
        container.innerHTML = `
          <table style="width: 100%; font-size: 13px;">
            <tr style="vertical-align: top;">
              <td width="35px">NdF: <span id="spell_ndf-${side}"></span><br>Raro: <span id="spell_rare-${side}"></span></td>
              <td width="110px">
                Feitiço: <input id="spell-name-${side}" style="width: 90%;">
                <br>Obs.: <span id="spell_obs-${side}"></span>
              </td>
              <td width="43px">
                Dano: <span id="spell_dmg-${side}"></span><br>
                Dur.: <span id="spell_duration-${side}"></span><br>
                Con.: <span id="spell_concentration-${side}"></span>
              </td>
              <td width="50px">
                Efeito:<br> <span id="spell_effect-${side}"></span><br>
                Condições:<br> <span id="spell_effect_condition-${side}"></span>
              </td>
              <td width="50px">
                Efeito Extra:<br> <span id="spell_extra-${side}"></span><br>
                Condições:<br> <span id="spell_extra_condition-${side}"></span>
              </td>
              <td id="action-links-section" width="70px" class="spells-action-container">
                Ações:<br>
                <div style="display: flex; flex-wrap: wrap; gap: 6px;"><span id="spell_ins-${side}"></span><span id="spell_raz-${side}"></span><span id="spell_mal-${side}"></span><span id="spell_sim-${side}"></span></div><br>
                Counter: <span id="spell_counteraction-${side}"></span>
              </td>
            </tr>
          </table>
        `;

        setupAutocomplete(`spell-name-${side}`, side);
      });
    }

    // Preenche os dados de acordo com o feitiço selecionado
    function populateSpellData(side) {
  const input = document.getElementById(`spell-name-${side}`);
  const name = input.value.trim();
  const spell = spellsData.find(s => s.spell_name === name);
  if (!spell) return;

  const spellNdf = parseInt(spell.spell_ndf) || 0;
  const charNdf = parseInt(document.getElementById(`char_ndf-${side}`)?.textContent.trim()) || 0;

  const diff = charNdf - spellNdf;
  const halfSmall = Math.floor(Math.abs(diff) / 2);
  const halfBig = Math.abs(diff) - halfSmall;

  const bonusToInput = diff >= 0 ? halfSmall : -halfSmall;
  const bonusToDmg = (diff === 0) ? "" : `<span style="margin-left: 6px;">${diff >= 0 ? "+" : "-"}${halfBig}</span>`;
  const showWarning = diff < 0 ? `<span style="margin-left: 6px; color: orange;">⚠️</span>` : "";

  // Preenche os campos da tabela de feitiço
  document.getElementById(`spell_ndf-${side}`).innerHTML = spell.spell_ndf + showWarning;
  document.getElementById(`spell_rare-${side}`).textContent = spell.spell_rare === "1" ? "⭐" : "";
  document.getElementById(`spell_obs-${side}`).textContent = spell.spell_obs;
  document.getElementById(`spell_dmg-${side}`).innerHTML = spell.spell_dmg + bonusToDmg;
  document.getElementById(`spell_duration-${side}`).textContent = spell.spell_duration;
  document.getElementById(`spell_concentration-${side}`).textContent = spell.spell_concentration === "1" ? "SIM" : "NÃO";
  document.getElementById(`spell_effect-${side}`).textContent = spell.spell_effect;
  document.getElementById(`spell_effect_condition-${side}`).textContent = spell.spell_effect_condition;
  document.getElementById(`spell_extra-${side}`).textContent = spell.spell_extra;
  document.getElementById(`spell_extra_condition-${side}`).textContent = spell.spell_extra_condition;
  document.getElementById(`spell_ins-${side}`).textContent = spell.spell_ins;
  document.getElementById(`spell_raz-${side}`).textContent = spell.spell_raz;
  document.getElementById(`spell_mal-${side}`).textContent = spell.spell_mal;
  document.getElementById(`spell_sim-${side}`).textContent = spell.spell_sim;
  document.getElementById(`spell_counteraction-${side}`).textContent = spell.spell_counteraction;

  // Aplica o bônus ao campo de input
  const bonusInput = document.getElementById(`fixedbonus-${side}`);
  if (bonusInput) bonusInput.value = bonusToInput;

  // Reestiliza os botões de ação
  styleSpellActions(side);
}



    // Ativa autocomplete em um input
    function setupAutocomplete(inputId, side) {
      const input = document.getElementById(inputId);
      input.setAttribute("list", `spells-list-${side}`);
      const datalist = document.createElement("datalist");
      datalist.id = `spells-list-${side}`;
      spellsList.forEach(spell => {
        const opt = document.createElement("option");
        opt.value = spell;
        datalist.appendChild(opt);
      });
      document.body.appendChild(datalist);

      input.addEventListener("change", () => populateSpellData(side));
    }
  </script>
<table border="0" cellpadding="0" cellspacing="0" class="twocell-table">
<tr>
<!-- Character A Cell -->
<td valign="top">
<div class="char-block" id="char-a">
<!-- Character Info Table -->
<center><table border="1" cellpadding="10" name="Character-A" style="border-collapse:collapse; table-layout:fixed; width:95%; background-color: #151515; border-radius: 4px;">
<colgroup>
<col style="width:150px;"/>
<col style="width:140px;"/>
<col style="width:190px;"/>
<col style="width:70px;"/>
<col style="width:140px;"/>
<col style="width:100px;"/>
</colgroup>
<tr>
<td id="char_avatar-a" rowspan="2"></td>
<td colspan="2" height="60"><select class="char-name" id="char-select-a"></select>
<div style="text-align: right">(<span class="minititle" id="char_player-a"></span>)</div></td>
<td colspan="3">
<div style="display: flex; gap: 18px; align-items: flex-start; width: 100%;">
<!-- HP -->
<div style="width: 155px;">
<div>
<div style="text-align: right; width: 134px;">
        🩸<span class="text-hp" id="char_hp-a"></span> /
        <span class="text-hp" id="char_maxhp-a"></span>
</div>
</div>
<input class="slider-top" id="char_hp_range-a" style="width: 135px; display: block;" type="range"/>
</div>
<!-- Energy -->
<div style="width: 155px;">
<div>
<div style="text-align: right; width: 134px;">
        ⚡<span class="text-energy" id="char_energy-a"></span> /
        <span class="text-energy" id="char_maxenergy-a"></span>
</div>
</div>
<input class="slider-top" id="char_energy_range-a" style="width: 135px; display: block;" type="range"/>
</div>
</div>
</td>
</tr>
<tr>
<td colspan="3" height="110" style="text-align: center; vertical-align: top;">
<div style="display: flex; gap: 10px; padding-left: 12px;">
<table border="1"><tr><td class="atr-num-ins" height="60" id="char_ins-a" width="70"></td></tr><tr><td class="atr">🔥 INS</td></tr></table>
<table border="1"><tr><td class="atr-num-sim" height="60" id="char_sim-a" width="70"></td></tr><tr><td class="atr">❤️ SIM</td></tr></table>
<table border="1"><tr><td class="atr-num-raz" height="60" id="char_raz-a" width="70"></td></tr><tr><td class="atr">⚙️ RAZ</td></tr></table>
<table border="1"><tr><td class="atr-num-mal" height="60" id="char_mal-a" width="70"></td></tr><tr><td class="atr">𖦹 MAL</td></tr></table>
</div>
</td>
<td rowspan="2" style="text-align: center; text-align: center; vertical-align: top;">
<div class="frame"><span class="title">BÔNUS</span><br/>
<span class="action-variable" id="char_bonus1-a"></span><br/>
<span class="action-variable" id="char_bonus2-a"></span><br/>
<span class="action-variable" id="char_bonus3-a"></span><br/>
<span class="action-variable" id="char_bonus4-a"></span><br/>
<span class="action-variable" id="char_bonus5-a"></span><br/>
<span class="action-variable" id="char_bonus6-a"></span><br/></div><br/>
<div class="frame"><span class="title">DEDUÇÕES</span><br/>
<span class="action-variable" id="char_deduc1-a"></span><br/>
<span class="action-variable" id="char_deduc2-a"></span><br/>
<span class="action-variable" id="char_deduc3-a"></span></div>
</td>
<td rowspan="2" style="vertical-align: top;">
<div style="display: flex; flex-direction: column; align-items: center; ">
<table border="1"><tr><td class="atr-num-none" height="40" id="char_por-a" width="50"></td></tr><tr><td class="atr">POR</td></tr></table>
<table border="1"><tr><td class="atr-num-none" height="40" id="char_ndf-a" width="50"></td></tr><tr><td class="atr">NdF</td></tr></table><br/>
<span class="atr">Agi <span class="title" id="char_agi-a" style="text-align: left;"></span></span>
<span class="atr">Per <span class="title" id="char_passiveperc-a" style="text-align: left;"></span></span>
<span class="atr">✦ <input class="cond-obs" data-tooltip="Pontos de Naração" id="char_narrativepoints-a" placeholder="0" style="width:15px; font-size:15px; padding:4px;" type="text"/></span><br/>
<div style="display: flex; gap: 4px; align-items: center;">
<button class="button" id="inc-btn-a">+</button>
<button class="button" id="dec-btn-a">−</button>
</div><br/>
<button class="button" id="obs-toggle-a">Obs.</button>
</div>
</td>
</tr>
<tr>
<td colspan="2">
<div class="slider-set" style="width: 300px;">
<div class="separated"><span class="minititle">Medo</span><span>Raiva</span></div>
<div class="slider-container">
<input class="slider" id="char_fear_anger-a" max="3" min="-3" step="1" type="range" value="0"/>
</div>
<div class="separated"><span>Desconfiança</span><span>Afeto</span></div>
<div class="slider-container">
<input class="slider" id="char_distrust_trust-a" max="3" min="-3" step="1" type="range" value="0"/>
</div>
<div class="separated"><span>Estresse</span><span>Calma</span></div>
<div class="slider-container">
<input class="slider" id="char_stress_calm-a" max="3" min="-3" step="1" type="range" value="0"/>
</div>
<div class="separated"><span>Culpa</span><span>Satisfação</span></div>
<div class="slider-container">
<input class="slider" id="char_guilt_satisf-a" max="3" min="-3" step="1" type="range" value="0"/>
</div>
</div> </td>
<td colspan="2" style="text-align: center; vertical-align: top;">
<div id="input-container-a" style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
<span class="title">CONDIÇÕES</span>
<div style="display: flex; gap: 6px; align-items: center;">
<input id="cond-a" placeholder="Nome da condição" style="width: 140px; padding: 4px; font-size: 14px;" type="text"/>
<input id="cond-turns-a" min="0" placeholder="Turnos" style="width: 60px; padding: 4px; font-size: 14px;" type="number"/>
<button onclick="addTag('a','cond')">+</button>
</div>
<div class="tag-list" id="cond-tags-a"></div>
</div>
</td>
</tr>
<tr style="border-top-style: solid; border-top-color: #222;">
<td colspan="6">
<div id="obs-field-a" style="display: none; margin-top: 6px;">
<textarea id="char_obs-a" placeholder="Adicione uma observação e pressione Enter..." rows="3" style="width: 95%; font-size: 15px; padding: 5px;"></textarea>
</div>
</td>
</tr>
</table></center>
<!-- Action Roller goes here! -->
<center><table class="roll-section" id="roll-section-a" style="width: 95%;">
<tr>
<td style="width:600px;">
<span class="roll-formula sub-variable" id="action_formula_lit-a"></span>
</td>
<td rowspan="2">
<button class="button" id="rollalldice-a">Rolar!</button>
</td>
<td>
<span id="roll_result-a"></span>
</td>
</tr>
<tr>
<td class="dice-rolling-line" id="dice-rolling-line">
<div class="back-variable dice-select-block" id="selected_att-block-a">
<span id="selected_att-a"></span>
<span class="sub-variable"><span id="selected_att_label-a"></span>
</span>
</div>
        +
        <div class="back-variable dice-select-block" id="dice-select-block-a">
<input id="diceamount-a" min="1" style="width:50px; font-size: 16px; text-align: center;" type="number" value="1">
<span id="diceamount_label-a"></span>
<span class="sub-variable">DADOS</span>
</input></div>
        +
        <div class="back-variable dice-select-block" id="fixedbonus-block-a">
<input id="fixedbonus-a" style="width:50px; font-size: 16px; text-align: center;" type="number" value="0">
<span id="fixedbonus_label-a"></span>
<span class="sub-variable">BÔNUS FIXO</span>
</input></div>
        +
        <span id="specialdice_controls-a" style="display: flex; align-items: center; gap: 4px;">
<span id="specialdice_area-a"></span>
<button class="button" id="add-special-a" title="Novo Dado" type="button">✦</button>
</span>
<span style="opacity: 20%">=
        <span id="partialresult-a"></span></span>
</td>
<td>
<span id="roll_breakdown-a"></span>
</td>
</tr>
</table></center>
<span id="specialdice-a" style="display:none;"></span>
<span id="partialresult_log-a" style="display:none;"></span>
<!-- Action Info Table -->
<center><table border="1" cellpadding="10" cellspacing="0" class="back-variable" id="back-div-a" style="text-align: center; width:95%; margin-top: 12px; border-radius: 4px;">
<tr height="60">
<td rowspan="7" width="240"><span class="cover-img" id="img_action-a"></span></td>
<td width="60"><div style="display: inline-flex; gap: 5px;"><span class="img" id="att_img-a"></span> <span class="text-variable" id="selected_att_name-a"></span></div></td>
<td width="60"><span class="text-variable" id="action_energy-a"></span></td>
<td width="60"><span class="text-variable-emoji" id="action_type1-a"></span></td>
<td width="60"><span class="text-variable-emoji" id="action_type2-a"></span></td>
<td width="60"><span class="text-variable-emoji" id="action_type3-a"></span></td>
<td width="60"><span class="text-variable-emoji" id="action_group_possib-a"></span></td>
<td width="90"><span class="sub-variable" id="action_type-a" style="font-size: 14px; text-transform: uppercase;"></span></td>
</tr>
<tr height="70">
<td class="light-div" colspan="6" id="light-div-action-a"><select class="title-variable" id="action-select-a"></select></td>
<td class="light-div right-gap" id="light-div-symbol-a" style="margin-left: 5px;"><span class="text-variable" id="img_action_type-a"></span></td>
</tr>
<tr height="40">
<td class="dark-div" colspan="3" id="dark-div-1-a"><span class="sub-variable" id="cell-contra-a">ROLA CONTRA</span></td>
<td class="dark-div" colspan="2" id="dark-div-2-a"><span class="sub-variable" id="cell-bonus-se-a">BÔNUS SE</span></td>
<td class="dark-div right-gap" colspan="2" id="dark-div-3-a"><span class="sub-variable" id="cell-adv-bonus-se-a">ADVERSÁRIO TEM BÔNUS SE</span></td>
</tr>
<tr height="50">
<td class="dark-div" colspan="3" id="dark-div-4-a"><span id="counter-a"></span></td>
<td class="dark-div" colspan="2" id="dark-div-5-a"><span class="strong-variable" id="has_bonus-a"></span></td>
<td class="dark-div right-gap" colspan="2" id="dark-div-6-a"><span class="strong-variable" id="opp_has_bonus-a"></span></td>
</tr>
<tr height="90">
<td class="light-div right-gap" colspan="7" id="light-div-desc-a" style="padding: 20px; !important;"><span class="descr-variable" id="action_description-a"></span></td>
</tr>
<tr height="80">
<td class="dark-div right-gap right-gap bottom-gap" colspan="7" id="dark-div-7-a" style="padding: 20px; !important;"><span class="sub-variable" id="action_condition-a" style="font-size: 14px; text-transform: uppercase;"></span></td>
</tr>
</table></center>
</div>
</td>
<!-- Character B Cell (everything repeated, with only interactive/output ids made unique with -b) -->
<td valign="top">
<div class="char-block" id="char-b">
<!-- Character Info Table -->
<table border="1" cellpadding="10" name="Character-B" style="border-collapse:collapse; table-layout:fixed; width:95%; background-color: #151515; border-radius: 4px;">
<colgroup>
<col style="width:150px;"/>
<col style="width:140px;"/>
<col style="width:190px;"/>
<col style="width:70px;"/>
<col style="width:140px;"/>
<col style="width:100px;"/>
</colgroup>
<tr>
<td id="char_avatar-b" rowspan="2"></td>
<td colspan="2" height="60"><select class="char-name" id="char-select-b"></select>
<div style="text-align: right">(<span class="minititle" id="char_player-b"></span>)</div></td>
<td colspan="3">
<div style="display: flex; gap: 18px; align-items: flex-start; width: 100%;">
<div style="width: 155px;">
<div>
<div style="text-align: right; width: 134px;">
                  🩸<span class="text-hp" id="char_hp-b"></span> /
                  <span class="text-hp" id="char_maxhp-b"></span>
</div>
</div>
<input class="slider-top" id="char_hp_range-b" style="width: 135px; display: block;" type="range"/>
</div>
<div style="width: 155px;">
<div>
<div style="text-align: right; width: 134px;">
                  ⚡<span class="text-energy" id="char_energy-b"></span> /
                  <span class="text-energy" id="char_maxenergy-b"></span>
</div>
</div>
<input class="slider-top" id="char_energy_range-b" style="width: 135px; display: block;" type="range"/>
</div>
</div>
</td>
</tr>
<tr>
<td colspan="3" height="110" style="text-align: center; vertical-align: top;">
<div style="display: flex; gap: 10px; padding-left: 12px;">
<table border="1"><tr><td class="atr-num-ins" height="60" id="char_ins-b" width="70"></td></tr><tr><td class="atr">🔥 INS</td></tr></table>
<table border="1"><tr><td class="atr-num-sim" height="60" id="char_sim-b" width="70"></td></tr><tr><td class="atr">❤️ SIM</td></tr></table>
<table border="1"><tr><td class="atr-num-raz" height="60" id="char_raz-b" width="70"></td></tr><tr><td class="atr">⚙️ RAZ</td></tr></table>
<table border="1"><tr><td class="atr-num-mal" height="60" id="char_mal-b" width="70"></td></tr><tr><td class="atr">𖦹 MAL</td></tr></table>
</div>
</td>
<td rowspan="2" style="text-align: center; vertical-align: top;">
<div class="frame"><span class="title">BÔNUS</span><br/>
<span class="action-variable" id="char_bonus1-b"></span><br/>
<span class="action-variable" id="char_bonus2-b"></span><br/>
<span class="action-variable" id="char_bonus3-b"></span><br/>
<span class="action-variable" id="char_bonus4-b"></span><br/>
<span class="action-variable" id="char_bonus5-b"></span><br/>
<span class="action-variable" id="char_bonus6-b"></span><br/></div><br/>
<div class="frame"><span class="title">DEDUÇÕES</span><br/>
<span class="action-variable" id="char_deduc1-b"></span><br/>
<span class="action-variable" id="char_deduc2-b"></span><br/>
<span class="action-variable" id="char_deduc3-b"></span></div>
</td>
<td rowspan="2" style="vertical-align: top;">
<div style="display: flex; flex-direction: column; align-items: center;">
<table border="1"><tr><td class="atr-num-none" height="40" id="char_por-b" width="50"></td></tr><tr><td class="atr">POR</td></tr></table>
<table border="1"><tr><td class="atr-num-none" height="40" id="char_ndf-b" width="50"></td></tr><tr><td class="atr">NdF</td></tr></table><br/>
<span class="atr">Agi <span class="title" id="char_agi-b" style="text-align: left;"></span></span>
<span class="atr">Per <span class="title" id="char_passiveperc-b" style="text-align: left;"></span></span>
<span class="atr">✦ <input class="cond-obs" data-tooltip="Pontos de Naração" id="char_narrativepoints-b" placeholder="0" style="width:15px; font-size:15px; padding:4px;" type="text"/></span><br/>
<div style="display: flex; gap: 4px; align-items: center;">
<button class="button" id="inc-btn-b">+</button>
<button class="button" id="dec-btn-b">−</button>
</div><br/>
<button class="button" id="obs-toggle-b">Obs.</button>
</div>
</td>
</tr>
<tr>
<td colspan="2">
<div class="slider-set" style="width: 300px;">
<div class="separated"><span class="minititle">Medo</span><span>Raiva</span></div>
<div class="slider-container">
<input class="slider" id="char_fear_anger-b" max="3" min="-3" step="1" type="range" value="0"/>
</div>
<div class="separated"><span>Desconfiança</span><span>Afeto</span></div>
<div class="slider-container">
<input class="slider" id="char_distrust_trust-b" max="3" min="-3" step="1" type="range" value="0"/>
</div>
<div class="separated"><span>Estresse</span><span>Calma</span></div>
<div class="slider-container">
<input class="slider" id="char_stress_calm-b" max="3" min="-3" step="1" type="range" value="0"/>
</div>
<div class="separated"><span>Culpa</span><span>Satisfação</span></div>
<div class="slider-container">
<input class="slider" id="char_guilt_satisf-b" max="3" min="-3" step="1" type="range" value="0"/>
</div>
</div>
</td>
<td colspan="2" style="text-align: center; vertical-align: top;">
<div id="input-container-b" style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
<span class="title">CONDIÇÕES</span>
<div style="display: flex; gap: 6px; align-items: center;">
<input class="cond-obs" id="cond-b" placeholder="Nome da condição" style="width: 140px; padding: 4px; font-size: 14px;" type="text"/>
<input id="cond-turns-b" min="0" placeholder="Turnos" style="width: 60px; padding: 4px; font-size: 14px;" type="number"/>
<button onclick="addTag('b','cond')">+</button>
</div>
<div class="tag-list" id="cond-tags-b"></div>
</div>
</td>
</tr>
<tr style="border-top-style: solid; border-top-color: #222;">
<td colspan="6">
<div id="obs-field-b" style="display: none; margin-top: 6px;">
<textarea id="char_obs-b" placeholder="Adicione uma observação e pressione Enter..." rows="3" style="width: 95%; font-size: 15px; padding: 5px;"></textarea>
</div>
</td>
</tr>
</table>
<!-- Action Roller for B -->
<table class="roll-section" id="roll-section-b" style="width: 95%;">
<tr>
<td style="width:600px;">
<span class="roll-formula sub-variable" id="action_formula_lit-b"></span>
</td>
<td rowspan="2">
<button class="button" id="rollalldice-b">Rolar!</button>
</td>
<td>
<span id="roll_result-b"></span>
</td>
</tr>
<tr>
<td class="dice-rolling-line" id="dice-rolling-line-b">
<div class="back-variable dice-select-block" id="selected_att-block-b">
<span id="selected_att-b"></span>
<span class="sub-variable"><span id="selected_att_label-b"></span></span>
</div>
      +
      <div class="back-variable dice-select-block" id="dice-select-block-b">
<input id="diceamount-b" min="1" style="width:50px; font-size: 16px; text-align: center;" type="number" value="1">
<span id="diceamount_label-b"></span>
<span class="sub-variable">DADOS</span>
</input></div>
      +
      <div class="back-variable dice-select-block" id="fixedbonus-block-b">
<input id="fixedbonus-b" style="width:50px; font-size: 16px; text-align: center;" type="number" value="0">
<span id="fixedbonus_label-b"></span>
<span class="sub-variable">BÔNUS FIXO</span>
</input></div>
      +
      <span id="specialdice_controls-b" style="display: flex; align-items: center; gap: 4px;">
<span id="specialdice_area-b"></span>
<button class="button" id="add-special-b" title="Novo Dado" type="button">✦</button>
</span>
<span style="opacity: 20%">=
        <span id="partialresult-b"></span></span>
</td>
<td>
<span id="roll_breakdown-b"></span>
</td>
</tr>
</table>
<span id="specialdice-b" style="display:none;"></span>
<span id="partialresult_log-b" style="display:none;"></span>
<!-- Action B Info Table -->
<table border="1" cellpadding="10" cellspacing="0" class="back-variable" id="back-div-b" style="text-align: center; width:95%; margin-top: 12px; border-radius: 4px;">
<tr height="60">
<td rowspan="7" width="240"><span class="cover-img" id="img_action-b"></span></td>
<td width="60"><div style="display: inline-flex; gap: 5px;"><span class="img" id="att_img-b"></span> <span class="text-variable" id="selected_att_name-b"></span></div></td>
<td width="60"><span class="text-variable" id="action_energy-b"></span></td>
<td width="60"><span class="text-variable-emoji" id="action_type1-b"></span></td>
<td width="60"><span class="text-variable-emoji" id="action_type2-b"></span></td>
<td width="60"><span class="text-variable-emoji" id="action_type3-b"></span></td>
<td width="60"><span class="text-variable-emoji" id="action_group_possib-b"></span></td>
<td width="90"><span class="sub-variable" id="action_type-b" style="font-size: 14px; text-transform: uppercase;"></span></td>
</tr>
<tr height="70">
<td class="light-div" colspan="6" id="light-div-action-b"><select class="title-variable" id="action-select-b"></select></td>
<td class="light-div right-gap" id="light-div-symbol-b" style="margin-left: 5px;"><span class="text-variable" id="img_action_type-b"></span></td>
</tr>
<tr height="40">
<td class="dark-div" colspan="3" id="dark-div-1-b"><span class="sub-variable" id="cell-contra-b">ROLA CONTRA</span></td>
<td class="dark-div" colspan="2" id="dark-div-2-b"><span class="sub-variable" id="cell-bonus-se-b">BÔNUS SE</span></td>
<td class="dark-div right-gap" colspan="2" id="dark-div-3-b"><span class="sub-variable" id="cell-adv-bonus-se-b">ADVERSÁRIO TEM BÔNUS SE</span></td>
</tr>
<tr height="50">
<td class="dark-div" colspan="3" id="dark-div-4-b"><span id="counter-b"></span></td>
<td class="dark-div" colspan="2" id="dark-div-5-b"><span class="strong-variable" id="has_bonus-b"></span></td>
<td class="dark-div right-gap" colspan="2" id="dark-div-6-b"><span class="strong-variable" id="opp_has_bonus-b"></span></td>
</tr>
<tr height="90">
<td class="light-div right-gap" colspan="7" id="light-div-desc-b" style="padding: 20px;"><span class="descr-variable" id="action_description-b"></span></td>
</tr>
<tr height="80">
<td class="dark-div right-gap bottom-gap" colspan="7" id="dark-div-7-b" style="padding: 20px;"><span class="sub-variable" id="action_condition-b" style="font-size: 14px; text-transform: uppercase;"></span></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<h2>Log de Rolagens</h2>
<div id="event-log-toolbar">
<button class="button" onclick="deleteSelectedLogs()">🗑️ Excluir</button>
<button class="button" onclick="toggleVisibility()">👁️ Ocultar Selecionados</button>
<select class="button" id="status-filter" onchange="filterStatusLogs()">
<option value="all">🔄 Todos</option>
<option value="visible">👁️ Visíveis</option>
<option value="hidden">🙈 Ocultos</option>
<option value="done">✅ Feitos</option>
<option value="todo">📝 A Fazer</option>
</select>
<button class="button" onclick="addManualLog()">➕ Linha Manual</button>
<button class="button" onclick="addTurnChange()">🔁 Mudança de Turno</button>
  Turno atual: <input id="current-turn" min="1" style="width: 60px;" type="number" value="1"/>
</div>
<div id="event-log-container"></div>
<!-- END -->

<script>
// Define constants and CSV paths
const charFields = [
  "char_avatar", "char_name", "char_player", "char_hp", "char_maxhp", "char_energy", "char_maxenergy",
  "char_ins", "char_sim", "char_raz", "char_mal", "char_por", "char_ndf", "char_agi",
  "char_bonus1", "char_bonus2", "char_bonus3", "char_bonus4", "char_bonus5", "char_bonus6",
  "char_deduc1", "char_deduc2", "char_deduc3", "char_passiveperc", "char_narrativepoints"
];
const actionFields = [
  "action_formula_lit", "att", "selected_att_label", "diceamount_label", "fixedbonus_label", 
  "img_action", "img_action_type", "action_type", "action_energy", "action_type1", "action_type2", "action_type3", "action_group_possib",
  "att_img", "counter", "has_bonus", "opp_has_bonus", "action_description", "action_condition"
];
// Keyword-to-attribute mapping
function setFields(charRow, actionRow, suffix) {
  const selectedAttNameEl = document.getElementById("selected_att_name" + suffix);
  if (selectedAttNameEl) {
    selectedAttNameEl.textContent = actionRow && actionRow.att ? actionRow.att.trim() : "";
  }

  charFields.forEach(f => {
    const el = document.getElementById(f + suffix);
    if (el) el.textContent = charRow && charRow[f] ? charRow[f] : "";
  });
  actionFields.forEach(f => {
    const el = document.getElementById(f + suffix);
    if (el) el.textContent = actionRow && actionRow[f] ? actionRow[f] : "";
  });
	  // Override and format counter separately
  const counterEl = document.getElementById("counter" + suffix);
  if (counterEl && actionRow && actionRow.counter) {
    const raw = actionRow.counter;
    const keywords = raw.split(/\s*,\s*/).map(str => str.trim());

    const keywordToAttr = {
      INS: [ "ATACAR", "BLOQUEAR, CONTRA-ATACAR", "INTERROMPER", "RESISTIR IMPACTO", "ARREMESSAR", "CARREGAR, FORÇA", "ESCALAR", "INICIATIVA, ALCANÇAR", "INTIMIDAR", "DESAFIAR", "FORÇA DE VONTADE", "ORIENTAÇÃO, SOBREVIVÊNCIA", "CLARIVIDÊNCIA" ],
      SIM: [ "PROTEGER OUTREM", "CURAR", "PERSUADIR", "BARGANHAR", "SEDUZIR", "INSPIRAR", "IMPLORAR", "ACALMAR", "DOMAR, TREINAR", "CONTATOS", "RELAÇÃO", "SENSIBILIDADE", "LIDERAR, COORDENAR" ],
      RAZ: [ "MIRAR", "PROTEGER-SE", "FOCAR", "ENFEITIÇAR, DESENFEITIÇAR", "TRANSFORMAR", "CONFECCIONAR, REPARAR", "PERCEPÇÃO", "INVESTIGAÇÃO", "OCLUMÊNCIA", "BUSCAR", "APRENDER", "CONHECIMENTO", "RESOLVER ENIGMA" ],
      MAL: [ "MALDIÇÃO, INFLIGIR DOR", "AZARAR", "DESVIAR", "EMBOSCAR", "SURPREENDER", "DISTRAIR", "FUGIR", "ENGANAR", "MANIPULAR", "RESISTIR SÚPLICA", "FURTIVIDADE", "ROUBAR, PLANTAR", "MANUSEAR" ]
    };

    const getAttrClass = (word) => {
      const upper = word.toUpperCase();
      if (keywordToAttr.INS.includes(upper)) return 'ins';
      if (keywordToAttr.SIM.includes(upper)) return 'sim';
      if (keywordToAttr.RAZ.includes(upper)) return 'raz';
      if (keywordToAttr.MAL.includes(upper)) return 'mal';
      return 'none';
    };

    const spansHTML = keywords.map(word => {
      const cssClass = getAttrClass(word);
      return `<span class="action-block ${cssClass}">${word}</span>`;
    }).join(" ");

    counterEl.innerHTML = spansHTML;
  }


  const attLabelEl = document.getElementById("selected_att_label" + suffix);
  if (attLabelEl) attLabelEl.textContent = actionRow && actionRow.att ? actionRow.att.trim() : "";

  let statVal = "-";
  if (actionRow && actionRow.att) {
    const statCode = actionRow.att.trim().toLowerCase();
    if (charRow && charRow["char_" + statCode] !== undefined) {
      statVal = charRow["char_" + statCode];
    }
  }
  const attValEl = document.getElementById("selected_att" + suffix);
  if (attValEl) attValEl.textContent = statVal;
}
const keywordToAttr = {
  // INS
  "ATACAR": "ins", "BLOQUEAR, CONTRA-ATACAR": "ins", "INTERROMPER": "ins", "RESISTIR IMPACTO": "ins",
  "ARREMESSAR": "ins", "CARREGAR, FORÇA": "ins", "ESCALAR": "ins", "INICIATIVA, ALCANÇAR": "ins",
  "INTIMIDAR": "ins", "DESAFIAR": "ins", "FORÇA DE VONTADE": "ins", "ORIENTAÇÃO, SOBREVIVÊNCIA": "ins", "CLARIVIDÊNCIA": "ins",
  // SIM
  "PROTEGER OUTREM": "sim", "CURAR": "sim", "PERSUADIR": "sim", "BARGANHAR": "sim", "SEDUZIR": "sim", "INSPIRAR": "sim",
  "IMPLORAR": "sim", "ACALMAR": "sim", "DOMAR, TREINAR": "sim", "CONTATOS": "sim", "RELAÇÃO": "sim", "SENSIBILIDADE": "sim", "LIDERAR, COORDENAR": "sim",
  // RAZ
  "MIRAR": "raz", "PROTEGER-SE": "raz", "FOCAR": "raz", "ENFEITIÇAR, DESENFEITIÇAR": "raz", "TRANSFORMAR": "raz", "CONFECCIONAR, REPARAR": "raz",
  "PERCEPÇÃO": "raz", "INVESTIGAÇÃO": "raz", "OCLUMÊNCIA": "raz", "BUSCAR": "raz", "APRENDER": "raz", "CONHECIMENTO": "raz", "RESOLVER ENIGMA": "raz",
  // MAL
  "MALDIÇÃO, INFLIGIR DOR": "mal", "AZARAR": "mal", "DESVIAR": "mal", "EMBOSCAR": "mal", "SURPREENDER": "mal", "DISTRAIR": "mal",
  "FUGIR": "mal", "ENGANAR": "mal", "MANIPULAR": "mal", "RESISTIR SÚPLICA": "mal", "FURTIVIDADE": "mal", "ROUBAR, PLANTAR": "mal", "MANUSEAR": "mal"
};

function renderCounterSpans(rawText) {
  if (!rawText) return "";
  return rawText
    .split(/\s*,\s*/) // Split only on commas, with optional spaces
    .map(kw => {
      const clean = kw.trim();
      const attr = keywordToAttr[clean.toUpperCase()] || "none";
      return `<span class="action-block ${attr}">${clean}</span>`;
    })
    .join(" ");
}





let charData = [], actionData = [];



 {
    setupConditionsAutocomplete(results.data, "a");
    setupConditionsAutocomplete(results.data, "b");

    // Se ainda houver selects (como em event_log_window), povoar:
    ["a", "b"].forEach(side => {
      const sel = document.getElementById(`cond-${side}`);
      if (sel?.tagName === "SELECT") {
        sel.innerHTML = results.data.map(row => `<option>${row.condition}</option>`).join("");
      }
    });
  }
});


	
	
function setupConditionsAutocomplete(data, side) {
  const input = document.getElementById(`cond-${side}`);
  if (!input) return;

  const wrapper = document.createElement("div");
  wrapper.style.position = "relative";
  input.parentNode.insertBefore(wrapper, input);
  wrapper.appendChild(input);

  const suggestionBox = document.createElement("div");
  suggestionBox.className = "autocomplete-suggestions";
  suggestionBox.style.position = "absolute";
  suggestionBox.style.top = "100%";
  suggestionBox.style.left = "0";
  suggestionBox.style.right = "0";
  suggestionBox.style.background = "#222";
  suggestionBox.style.border = "1px solid #444";
  suggestionBox.style.zIndex = "999";
  suggestionBox.style.maxHeight = "150px";
  suggestionBox.style.overflowY = "auto";
  suggestionBox.style.display = "none";
  wrapper.appendChild(suggestionBox);

  input.addEventListener("input", () => {
    const value = input.value.trim().toLowerCase();
    suggestionBox.innerHTML = "";

    if (!value) {
      suggestionBox.style.display = "none";
      return;
    }

    const matches = data.filter(row =>
      row.condition?.toLowerCase().includes(value)
    );

    if (matches.length === 0) {
      suggestionBox.style.display = "none";
      return;
    }

    matches.forEach(match => {
      const option = document.createElement("div");
      option.textContent = match.condition;
      option.style.padding = "4px 8px";
      option.style.cursor = "pointer";
      option.style.borderBottom = "1px solid #333";

      option.addEventListener("click", () => {
        input.value = match.condition;
        input.setAttribute(
          "data-tooltip",
          `${match.cond_category || ''}: ${match.cond_description || ''}\nEFEITO: ${match.cond_effects || ''}`
        );
        input.classList.add("filled");
        suggestionBox.style.display = "none";
      });

      suggestionBox.appendChild(option);
    });

    suggestionBox.style.display = "block";
  });

  // Fecha o dropdown ao clicar fora
  document.addEventListener("click", (e) => {
    if (!wrapper.contains(e.target)) {
      suggestionBox.style.display = "none";
    }
  });

  // Restaura o tooltip ao passar o mouse
  input.addEventListener("mouseenter", () => {
    if (input.dataset.tooltip) input.title = input.dataset.tooltip;
  });
}


function setupDropdowns() {
  const charSelA = document.getElementById("char-select-a");
  const charSelB = document.getElementById("char-select-b");
  const actSelA = document.getElementById("action-select-a");
  const actSelB = document.getElementById("action-select-b");

charSelA.innerHTML = charData.map((row, i) => `<option class="option" value="${i}">${row.char_name}</option>`).join('');
charSelB.innerHTML = charData.map((row, i) => `<option class="option" value="${i}">${row.char_name}</option>`).join('');
actSelA.innerHTML = actionData.map((row, i) => `<option class="option" value="${i}">${row.action}</option>`).join('');
actSelB.innerHTML = actionData.map((row, i) => `<option class="option" value="${i}">${row.action}</option>`).join('');

  function refreshA() {
  setFields(charData[charSelA.value], actionData[actSelA.value], "-a");
  updatePartialResult("a");
  updateStatRanges("a");
  setTimeout(() => {
    applyActionVariableClasses("a");
    applySimpleVariableClassesFromField("a");
    }, 30);
}
  function refreshB() {
    setFields(charData[charSelB.value], actionData[actSelB.value], "-b");
    updatePartialResult("b");
    updateStatRanges("b");
      setTimeout(() => {
    applyActionVariableClasses("b");
    applySimpleVariableClassesFromField("b");
     }, 30);

  }
  charSelA.onchange = refreshA;
  actSelA.onchange = refreshA;
  charSelB.onchange = refreshB;
  actSelB.onchange = refreshB;

  refreshA();
  refreshB();
  setupDiceSection("a");
  setupDiceSection("b");
}

;

      lines.slice(1).forEach(line => {
        const cols = line.split(',').map(c => c.trim());
        const action = cols[actionIndex]?.toUpperCase();
        const att = cols[attIndex]?.toUpperCase();
        if (action && att) {
          lookup[action] = att;
        }
      });

      const elements = document.querySelectorAll(`.action-variable[id$="-${groupSuffix}"]`);
      elements.forEach(el => {
        const content = el.textContent.trim().toUpperCase();
        const matchedAtt = lookup[content];
        el.classList.remove('ins', 'sim', 'raz', 'mal', 'none');
        switch (matchedAtt) {
          case 'INS': el.classList.add('ins'); break;
          case 'SIM': el.classList.add('sim'); break;
          case 'RAZ': el.classList.add('raz'); break;
          case 'MAL': el.classList.add('mal'); break;
          default: el.classList.add('none');
        }
      });
    })
    
}

	function applySimpleVariableClassesFromField(groupSuffix = 'a') {
  const attrEl = document.getElementById(`selected_att_name-${groupSuffix}`);
  if (!attrEl) return;

  const attrRaw = attrEl.textContent.trim().toUpperCase();
  const att = ['INS', 'SIM', 'RAZ', 'MAL'].includes(attrRaw) ? attrRaw : 'NONE';

  const classTypes = [
    'title-variable', 'sub-variable',
    'descr-variable', 'strong-variable',
    'back-variable', 'light-div', 'dark-div', 'text-variable', 'text-variable-emoji'
  ];

  classTypes.forEach(classType => {
    const elements = document.querySelectorAll(`.${classType}[id$="-${groupSuffix}"]`);
    elements.forEach(el => {
      el.classList.remove('ins', 'sim', 'raz', 'mal', 'none');
      el.classList.add(att.toLowerCase());
    });
  });
}
	
	
window.onload = loadData;
	
	
function getActionAttrKey(actionRow) {
  if (!actionRow) return "";
  return (actionRow.att || "").toLowerCase();
}

function loadData() {
   {
       {
          charData = charResults.data;
          actionData = actionResults.data;
          setupDropdowns();
        }
      });
    }
  });
}

// --- DICE LOGIC PATCH ---

function setupDiceSection(side) {
  // Special dice add/remove
  const area = document.getElementById('specialdice_area-' + side);
  const btn = document.getElementById('add-special-' + side);
  if (!area || !btn) return;
  if (area.dataset.initialized) return;
  area.dataset.initialized = "true";
  area.innerHTML = '';
  btn.innerHTML = '✦';
  btn.title = 'Novo Dado';

  btn.onclick = function () {
    const group = document.createElement('span');
    group.className = "dice-group special-dice-box";
    group.innerHTML = `
      <input type="number" min="1" value="1" style="width:32px;" class="special-amount">
      <span style="font-size:13px;">d</span>
      <input type="number" min="0" value="0" style="width:32px;" class="special-min">
      <span style="font-size:13px;">–</span>
      <input type="number" min="1" value="6" style="width:32px;" class="special-max">
      <button type="button" class="button">×</button>
    `;
    group.querySelector("button").onclick = () => group.remove();
    area.appendChild(group);
  };

  // Partial Result + Roll logic
  function getSelectedAttVal() {
    const el = document.getElementById('selected_att-' + side);
    const val = parseInt(el && el.textContent ? el.textContent : "0", 10);
    return isNaN(val) ? 0 : val;
  }

  function updatePartial() {
    const att = getSelectedAttVal();
    const bonus = parseInt(document.getElementById('fixedbonus-' + side).value) || 0;
    const partial = att + bonus;
    document.getElementById('partialresult-' + side).textContent = partial;
    document.getElementById('partialresult_log-' + side).textContent = partial;
  }

  document.getElementById('diceamount-' + side).oninput = updatePartial;
  document.getElementById('fixedbonus-' + side).oninput = updatePartial;
  updatePartial();

  // Roll dice logic
  document.getElementById('rollalldice-' + side).onclick = function () {
  const mainDice = Math.max(1, parseInt(document.getElementById('diceamount-' + side).value) || 1);
  const mainBonus = parseInt(document.getElementById('fixedbonus-' + side).value) || 0;
  const attVal = parseInt(document.getElementById('selected_att-' + side).textContent) || 0;

  let rolls = [];
  for (let i = 0; i < mainDice; ++i) {
    rolls.push(Math.floor(Math.random() * 4));
  }
  let sum = rolls.reduce((a, b) => a + b, 0);
  let total = attVal + mainBonus + sum;

  // Create breakdown list
  let breakdown = [
    `<span class="partial-result" title="Atributo Base"><b>${attVal}</b></span>`,
    `<span class="partial-result" title="Bônus Fixo"><b>${mainBonus}</b></span>`,
    ...rolls.map(r => `<span class="partial-result" title="Dado Padrão 0-3"><b>${r}</b></span>`)
  ];

  // Handle special dice
  let specialTotal = 0;
  const specialArea = document.getElementById('specialdice_area-' + side);
  specialArea.querySelectorAll('.dice-group').forEach(group => {
    const amount = parseInt(group.querySelector('.special-amount').value) || 1;
    const max = parseInt(group.querySelector('.special-max').value);
    const min = parseInt(group.querySelector('.special-min').value);
    for (let j = 0; j < amount; ++j) {
      const r = Math.floor(Math.random() * (max - min + 1)) + min;
      breakdown.push(`<span class="partial-result" title="Dado Especial ${min}-${max}*"><b>${r}</b></span>`);
      specialTotal += r;
    }
  });

  const finalSum = total + specialTotal;

  // Output
  document.getElementById('roll_breakdown-' + side).innerHTML = breakdown.join(" + ");
  document.getElementById('roll_result-' + side).innerHTML = `<br><span class="individual-result"><b>${finalSum}</b></span>`;
};
}

function updatePartialResult(side) {
  const att = parseInt(document.getElementById('selected_att-' + side).textContent) || 0;
  const bonus = parseInt(document.getElementById('fixedbonus-' + side).value) || 0;
  const partial = att + bonus;
  document.getElementById('partialresult-' + side).textContent = partial;
  document.getElementById('partialresult_log-' + side).textContent = partial;
}

function updateStatRanges(side) {
  // HP
  const hp = parseInt(document.getElementById('char_hp-' + side).textContent) || 0;
  const maxhp = parseInt(document.getElementById('char_maxhp-' + side).textContent) || 1;
  const hpRange = document.getElementById('char_hp_range-' + side);
  hpRange.min = 0;
  hpRange.max = maxhp;
  hpRange.value = hp;
  hpRange.style.accentColor = "crimson";
  hpRange.oninput = function() {
    document.getElementById('char_hp-' + side).textContent = this.value;
  };
	hpRange.classList.add("hp-slider-fill");
updateSliderFill(hpRange, "crimson");
hpRange.oninput = function () {
  document.getElementById('char_hp-' + side).textContent = this.value;
  updateSliderFill(this, "crimson");
};

  // Energy
  const energy = parseInt(document.getElementById('char_energy-' + side).textContent) || 0;
  const maxenergy = parseInt(document.getElementById('char_maxenergy-' + side).textContent) || 1;
  const energyRange = document.getElementById('char_energy_range-' + side);
  energyRange.min = 0;
  energyRange.max = maxenergy;
  energyRange.value = energy;
  energyRange.style.accentColor = "#FDA528";
  energyRange.oninput = function() {
    document.getElementById('char_energy-' + side).textContent = this.value;
  };
	energyRange.classList.add("energy-slider-fill");
updateSliderFill(energyRange, "#FDA528");
energyRange.oninput = function () {
  document.getElementById('char_energy-' + side).textContent = this.value;
  updateSliderFill(this, "#FDA528");
};
}

	// PRESERVE FUNCTION FOR RANGE FIELDS //
	function setCenteredGradient(slider, colorLeft, colorRight) {
      const value = parseInt(slider.value, 10);
      const percent = (Math.abs(value) / 3) * 50;

      let backgroundFill;

      if (value > 0) {
        backgroundFill = `linear-gradient(to right, 
          transparent 50%, 
          ${colorRight} 50%, 
          ${colorRight} ${50 + percent}%, 
          transparent ${50 + percent}%)`;
      } else if (value < 0) {
        backgroundFill = `linear-gradient(to right, 
          transparent ${50 - percent}%, 
          ${colorLeft} ${50 - percent}%, 
          ${colorLeft} 50%, 
          transparent 50%)`;
      } else {
        backgroundFill = `transparent`;
      }

      const base = `repeating-linear-gradient(
        to right,
        #222,
        #222 calc((100% / 6) - 3px),
        transparent calc((100% / 6) - 3px),
        transparent calc(100% / 6)
      )`;

      slider.style.background = backgroundFill !== 'transparent'
        ? `${backgroundFill}, ${base}`
        : base;
    }

    const sliders = [
      { id: 'char_fear_anger-a', left: '#08626D', right: '#B73D11' },
      { id: 'char_distrust_trust-a', left: '#423682', right: '#aa1e57' },
      { id: 'char_stress_calm-a', left: '#B73D11', right: '#423682' },
      { id: 'char_guilt_satisf-a', left: '#aa1e57', right: '#08626D' },
      { id: 'char_fear_anger-b', left: '#08626D', right: '#B73D11' },
      { id: 'char_distrust_trust-b', left: '#423682', right: '#aa1e57' },
      { id: 'char_stress_calm-b', left: '#B73D11', right: '#423682' },
      { id: 'char_guilt_satisf-b', left: '#aa1e57', right: '#08626D' }
    ];

    sliders.forEach(({ id, left, right }) => {
      const slider = document.getElementById(id);
      setCenteredGradient(slider, left, right);
      slider.addEventListener('input', () => {
        setCenteredGradient(slider, left, right);
      });
    });
	
function updateSliderFill(slider, color) {
  const value = (slider.value - slider.min) / (slider.max - slider.min);
  const percent = value * 100;
  slider.style.background = `linear-gradient(to right, ${color} 0%, ${color} ${percent}%, #333 ${percent}%, #333 100%)`;
}

	document.getElementById("obs-toggle-a").addEventListener("click", function () {
  const obsField = document.getElementById("obs-field-a");
  if (obsField) {
    const isVisible = obsField.style.display !== "none";
    obsField.style.display = isVisible ? "none" : "block";
  }	
});
	  document.getElementById("obs-toggle-b").addEventListener("click", function () {
  const obsField = document.getElementById("obs-field-b");
  if (obsField) {
    const isVisible = obsField.style.display !== "none";
    obsField.style.display = isVisible ? "none" : "block";
  }
});
	
   

document.getElementById("rollalldice-b").addEventListener("click", () => {
  // Supondo que sua lógica de rolagem já esteja aqui...
  // Agora adicionamos o envio do popup com log de confirmação:

  setTimeout(() => {
    const popup = window.open("event_log_window.html", "LogPopup", "width=1060,height=630");

    setTimeout(() => {
      const charAData = getCharacterData("a");
      const charBData = getCharacterData("b");

      console.log("✅ Enviando dados para o popup:", {
        charA: charAData,
        charB: charBData,
      });

      popup.postMessage({
        charA: charAData,
        charB: charBData, 
      }, "*");
    }, 500);
  }, 1000);
});

	  



function safeText(id) {
  const el = document.getElementById(id);
  return el ? el.textContent.trim() : "❓";
}

function safeNumber(id) {
  const el = document.getElementById(id);
  return el ? parseInt(el.textContent.trim() || "0") : 0;
}

function getCharacterData(side) {
  // ID reverso do adversário
  const other = side === "a" ? "b" : "a";

const nameSelect = document.getElementById(`char-select-${side}`);
const name = nameSelect?.options[nameSelect.selectedIndex]?.textContent.trim() || "❓";

const targetSelect = document.getElementById(`char-select-${side === "a" ? "b" : "a"}`);
const target = targetSelect?.options[targetSelect.selectedIndex]?.textContent.trim() || "❓";


  const action = document.getElementById(`action-select-${side}`)?.selectedOptions?.[0]?.textContent || "❓";
  const atr = document.getElementById(`selected_att_name-${side}`)?.textContent || "??";

  const bonus = parseInt(document.getElementById(`fixedbonus-${side}`)?.textContent || "0");
  const bonus_reason = "";

  // Resultado total
  const result = parseInt(document.getElementById(`roll_result-${side}`)?.textContent || "0");

  // Energia e HP atual
  const current_hp = parseInt(document.getElementById(`char_hp-${side}`)?.textContent || "0");
  const current_en = parseInt(document.getElementById(`char_energy-${side}`)?.textContent || "0");

  // Alterações de energia e HP (só para simular no log)
  const altered_hp = 0;
  const altered_en = parseInt(document.getElementById(`action_energy-${side}`)?.textContent || "0");

  // Breakdown com os tooltips
  const breakdown = Array.from(document.querySelectorAll(`#roll_breakdown-${side} span[title]`)).map(span => ({
    label: span.getAttribute("title"),
    value: parseInt(span.textContent) || 0
  }));
	// Ndf
	const ndfEl = document.getElementById(`char_ndf-${side}`);
  const ndf = ndfEl ? parseInt(ndfEl.textContent.trim()) || 0 : 0;
  
  const spell_dmg_el = document.getElementById(`spell_dmg-${side}`);
  const spell_dmg = spell_dmg_el ? spell_dmg_el.textContent.trim() : "";

  const spell_effect_condition = document.getElementById(`spell_effect_condition-${side}`)?.textContent || "";
  const spell_extra_condition = document.getElementById(`spell_extra_condition-${side}`)?.textContent || "";


  return {
    name,
    target,
    action,
    atr,
    bonus,
    bonus_reason,
    breakdown,
    result,
    altered_hp,
    altered_en,
    current_hp,
    current_en,
	  ndf,
    spell_dmg,
    spell_effect_condition,
    spell_extra_condition,

  };
}


function sendLogPopupData() {
  const popup = window.open("event_log_window.html", "LogPopup", "width=1060,height=630");

  const dataA = getCharacterData("a");
  const dataB = getCharacterData("b");

  setTimeout(() => {
    popup.postMessage({
      charA: dataA,
      charB: dataB,
      action: dataA.action,
      attribute: dataA.atr
    }, "*");
  }, 500);
}

function getFormattedTimestamp() {
    const now = new Date();
    const day = String(now.getDate()).padStart(2, "0");
    const mon = now.toLocaleString("en", { month: "short" });
    const year = String(now.getFullYear()).slice(-2);
    const hour = String(now.getHours()).padStart(2, "0");
    const min = String(now.getMinutes()).padStart(2, "0");
    return `${day}/${mon}/${year} ${hour}:${min}`;
  }

  // Recebe logs vindos do popup
  window.addEventListener("message", (event) => {
    if (!event.data || !event.data.logs) return;
    event.data.logs.forEach(log => addLogEntry(log));
  });

  // 🧩 Adiciona uma entrada ao topo do log
  function addLogEntry(content, isManual = false) {
    const container = document.getElementById("event-log-container");
    const row = document.createElement("div");
    row.className = "log-entry";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";

    const timestamp = document.createElement("div");
    timestamp.className = "log-timestamp";
    timestamp.style = "width: 120px; font-size: 11px; color: #666; margin-top: 6px;";
    timestamp.textContent = getFormattedTimestamp();

    const contentDiv = document.createElement("div");
    contentDiv.className = "log-content";
    contentDiv.dataset.manual = isManual;

    const statusCheckbox = document.createElement("input");
    statusCheckbox.type = "checkbox";
    statusCheckbox.className = "log-status";
    statusCheckbox.title = "Feito";

    if (isManual) {
      makeContentEditable(contentDiv, content);
    } else {
      contentDiv.innerHTML = content;
    }

    contentDiv.onclick = () => {
      if (contentDiv.dataset.manual === "true") {
        makeContentEditable(contentDiv, contentDiv.innerText.trim());
      }
    };

    row.appendChild(checkbox);
    row.appendChild(timestamp);
    row.appendChild(contentDiv);
    row.appendChild(statusCheckbox);

    container.prepend(row);
  }

  // 🧩 Torna editável novamente
  function makeContentEditable(container, value) {
    container.innerHTML = "";
    const textarea = document.createElement("textarea");
    textarea.value = value;
    textarea.onblur = () => {
      container.innerHTML = textarea.value;
    };
    container.appendChild(textarea);
    textarea.focus();
  }

  function addManualLog() {
    addLogEntry("Clique aqui e digite seu log...", true);
  }

  function addTurnChange() {
  // ⬆️ Parte 1: Avançar o turno
  const turnInput = document.getElementById("current-turn");
  const turno = parseInt(turnInput.value) || 1;
  addLogEntry(`📢 Mudança para o turno ${turno}`);
  turnInput.value = turno + 1;

  // ⬇️ Parte 2: Reduzir turnos das condições
  ["a", "b"].forEach(side => {
    const container = document.getElementById(`cond-tags-${side}`);
    if (!container) return;

    const tags = Array.from(container.querySelectorAll(".tag"));

    tags.forEach(tag => {
      const text = tag.textContent.trim();
      const match = text.match(/\((\d+)\)/); // Captura número entre parênteses

      if (match) {
        let num = parseInt(match[1]);
        num--;

        if (num <= 0) {
          tag.remove(); // Remove a condição
        } else {
          const conditionName = tag.dataset.value;
          tag.childNodes[0].textContent = `${conditionName} (${num})`;
        }
      }
    });
  });
}


  function deleteSelectedLogs() {
    document.querySelectorAll(".log-entry").forEach(entry => {
      if (entry.querySelector("input[type='checkbox']").checked) {
        entry.remove();
      }
    });
  }

  function toggleVisibility() {
    document.querySelectorAll(".log-entry").forEach(entry => {
      if (entry.querySelector("input[type='checkbox']").checked) {
        entry.classList.toggle("hidden-log");
      }
    });
  }

  // 🧩 Filtro por status
  function filterStatusLogs() {
    const filter = document.getElementById("status-filter").value;
    document.querySelectorAll(".log-entry").forEach(entry => {
      const isHidden = entry.classList.contains("hidden-log");
      const isDone = entry.querySelector(".log-status").checked;

      switch (filter) {
        case "all":
          entry.style.display = "flex";
          break;
        case "visible":
          entry.style.display = !isHidden ? "flex" : "none";
          break;
        case "hidden":
          entry.style.display = isHidden ? "flex" : "none";
          break;
        case "done":
          entry.style.display = isDone ? "flex" : "none";
          break;
        case "todo":
          entry.style.display = !isDone ? "flex" : "none";
          break;
      }
    });
  }
	
	function styleSpellActions(side) {
  const fields = ["ins", "raz", "mal", "sim"];
  fields.forEach(type => {
    const spanId = `spell_${type}-${side}`;
    const container = document.getElementById(spanId);
    if (!container) return;

    const rawText = container.textContent || "";
    const actions = rawText.split(",").map(a => a.trim()).filter(Boolean);

    container.innerHTML = ""; // Clear previous content

    actions.forEach(action => {
      const span = document.createElement("span");
      span.classList.add("action-block", type, "spell-action-button");

      // Armazena o valor completo como data-attribute
      span.dataset.full = action;

      // Exibe só até a primeira barra ou tudo, se não houver
      const displayText = action.split("/")[0].trim();
      span.textContent = displayText + (action.includes("/") ? " ..." : "");

      // Ao clicar, seleciona a ação no dropdown correspondente
      span.addEventListener("click", () => {
        const dropdown = document.getElementById(`action-select-${side}`);
        const options = Array.from(dropdown.options);
        const index = options.findIndex(opt => opt.textContent.trim() === action.trim());

        if (index >= 0) {
          dropdown.selectedIndex = index;
          dropdown.dispatchEvent(new Event("change")); // ativa refreshA/refreshB
        } else {
          alert(`Ação "${action}" não encontrada no dropdown.`);
        }
      });

      container.appendChild(span);
    });
  });
}

function addArenaCondition(side) {
  const condInput = document.getElementById(`char-cond-${side}`);
  const turnsInput = document.getElementById(`char-cond-turns-${side}`);
  const tagList = document.getElementById(`char-cond-tags-${side}`);
  const value = condInput.value.trim();
  const turns = parseInt(turnsInput.value) || 0;

  if (!value || [...tagList.children].some(tag => tag.dataset.value === value)) return;

  const displayTurns = turns < 0 ? "Enquanto houver concentração" :
                      turns === 0 ? "Indefinidamente" :
                      `${turns} turno(s)`;

  // Procurar tooltip baseado nos dados carregados
  const match = conditionsData?.find(c => c.condition === value);
  const tooltip = match ?
    `${match.cond_category || ''}: ${match.cond_description || ''}\nEFEITO: ${match.cond_effects || ''}` :
    "";

  const tag = document.createElement("span");
  tag.className = "tag";
  tag.dataset.value = value;
  tag.title = tooltip;
  tag.innerHTML = `${value} (${displayTurns}) <button onclick="this.parentElement.remove()">✕</button>`;
  tagList.appendChild(tag);

  condInput.value = "";
  turnsInput.value = "0";
}



function updateArenaConditionDescriptions(side) {
  const tagList = [...document.getElementById(`cond-tags-${side}`).children];
  const descDiv = document.getElementById(`cond-desc-${side}`);
  descDiv.innerHTML = tagList.map(tag => {
    const [name] = tag.dataset.value.split(" (");
    return `<div>🔹 <b>${name}</b>: ${conditionDescriptions[name] || "sem descrição"}</div>`;
  }).join("");
}

function addTag(side, type) {
  const inputId = type === "cond" ? `cond-${side}` : `${type}-${side}`;
  const turnsId = type === "cond" ? `cond-turns-${side}` : `${type}-turns-${side}`;
  const tagContainer = document.getElementById(`${type}-tags-${side}`);
  const input = document.getElementById(inputId);
  const turns = parseInt(document.getElementById(turnsId)?.value || "0");

  const value = input.value.trim();
  if (!value) return;

  // Evitar entradas duplicadas
  const existingTags = tagContainer.querySelectorAll("span");
  for (const tag of existingTags) {
    if (tag.dataset.value === value) return;
  }

  const span = document.createElement("span");
  span.className = "tag";
  span.dataset.value = value;

  let turnLabel = "";
  if (turns === 0) turnLabel = " (Indefinido)";
  else if (turns < 0) turnLabel = " (Concentração)";
  else turnLabel = ` (${turns})`;

  span.textContent = `${value}${turnLabel}`;

  // Tooltip opcional baseado no campo original
  if (input.dataset.tooltip) {
    span.title = input.dataset.tooltip;
  }

  const remove = document.createElement("button");
  remove.textContent = "x";
  remove.className = "tag-remove";
  remove.onclick = () => span.remove();
  span.appendChild(remove);

  tagContainer.appendChild(span);
  input.value = "";
  input.removeAttribute("data-tooltip");
}
</script>
<script type="module">
window.addEventListener("DOMContentLoaded", async () => {
  const db = getFirestore();

  async function populateDropdowns() {
    const chars = await getFirebaseCollection("characters_range");
    const dropdowns = [document.getElementById("char-select-a"), document.getElementById("char-select-b")];
    dropdowns.forEach(dropdown => {
      dropdown.innerHTML = "";
      chars.forEach(char => {
        const opt = document.createElement("option");
        opt.value = char.char_name;
        opt.textContent = char.char_name;
        dropdown.appendChild(opt);
      });
    });
  }

  function bindRealtimeCharSync(idSuffix) {
    const dropdown = document.getElementById("char-select-" + idSuffix);
    const hp = document.getElementById("char_hp-" + idSuffix);
    const energy = document.getElementById("char_energy-" + idSuffix);
    const bonus = document.getElementById("char_bonus1-" + idSuffix);
    const cond1 = document.getElementById("char_cond1-" + idSuffix);
    const cond2 = document.getElementById("char_cond2-" + idSuffix);

    let unsubscribe = null;

    function watchCharacter(name) {
      if (unsubscribe) unsubscribe(); // remove previous listener
      const ref = doc(db, "campaigns", "alpha", "characters_range", name);
      unsubscribe = onSnapshot(ref, snap => {
        const data = snap.data();
        if (data) {
          hp.value = data.char_hp ?? 0;
          energy.value = data.char_energy ?? 0;
          bonus.value = data.char_bonus1 ?? "-";
          cond1.value = data.char_cond1 ?? "-";
          cond2.value = data.char_cond2 ?? "-";
        }
      });
    }

    dropdown.addEventListener("change", () => watchCharacter(dropdown.value));

    hp.addEventListener("input", () => setFirebaseDocField("characters_range", dropdown.value, "char_hp", parseInt(hp.value)));
    energy.addEventListener("input", () => setFirebaseDocField("characters_range", dropdown.value, "char_energy", parseInt(energy.value)));
    cond1.addEventListener("input", () => setFirebaseDocField("characters_range", dropdown.value, "char_cond1", cond1.value));
    cond2.addEventListener("input", () => setFirebaseDocField("characters_range", dropdown.value, "char_cond2", cond2.value));

    watchCharacter(dropdown.value);
  }

  await populateDropdowns();
  bindRealtimeCharSync("a");
  bindRealtimeCharSync("b");
});
</script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCoO7sYTOcz_1JrW46VoRowvHYa5wUFSTk",
  authDomain: "rpg-prisma-f5a11.firebaseapp.com",
  projectId: "rpg-prisma-f5a11",
  storageBucket: "rpg-prisma-f5a11.appspot.com",
  messagingSenderId: "65278749627",
  appId: "1:65278749627:web:804f5d41adbab5351e729e"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script></body>
</html>
