<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<title>RPG Arena</title>
<style>
body { background: #0F0F0F; color: whitesmoke;}

	.twocell-table { width:100%; table-layout: fixed;}

	.char-block { width:100%; min-width: 420px; }

	.action-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }

	input, textarea { background: #191919; color: #fff; border: 1px solid #555; }

	table, th, td {
		border: none;
		
	}
	div {
		border-radius: 4px;
	}

	select {
		background-color: inherit;
		border-radius: 4px;
				
		.option {
			font-family: 'Faculty Glyphic';
			background-color: #222;
			font-size: 16px;
			color: whitesmoke;
			
		}
	}

  h2 {
    font-size: 24px;
    text-align: center;
    font-family: 'Nova Flat';
    font-weight: bold;
    
  }
		@font-face {
  		font-family: "NotoEmoji";
  		src: url("https://fonts.fonts.gstatic.com/s/notoemoji/v/latest/NotoEmoji-Regular.ttf") format("truetype");
  		unicode-range: U+1F000-1FAFF; /* Emoji block */
	}

.emoji {
  font-family: "NotoEmoji", sans-serif !important;
}
	
	.setup-row { display: flex; gap: 24px; margin-bottom: 18px; justify-content: center; }

	.separated {
	display: flex;
	justify-content: space-between;
	margin-bottom: 3px;
	font-family: 'Faculty Glyphic';
}
	
    .slider-set {
      width: 340px;
      font-size: 15px;
      margin: auto;
	  padding-left: 16px;
    }


    .slider-container {
      position: relative;
      width: 100%;
      margin-bottom: 9.5px;
	    }

    .slider {
      width: 100%;
      appearance: none;
      height: 5px;
      border-radius: 0;
      outline: none;
      z-index: 2;
      position: relative;
	  border: none;
      background-color: #222;
	}
	
	.slider-top {
	  width: 100%;
      appearance: none;
      height: 5px;
      border-radius: 0;
      outline: none;
      z-index: 2;
      position: relative;
	  border: none;
      background-color: #222;
	}

    .slider::-webkit-slider-thumb  {
      appearance: none;
      width: 10px;
      height: 10px;
      background: whitesmoke;
      cursor: pointer;
      border: none;
      margin-top: -2px;
      position: relative;
      z-index: 3;
	  opacity: 1%; 
    }

	.slider-top::-webkit-slider-thumb  {
      appearance: none;
      width: 10px;
      height: 10px;
      background: whitesmoke;
      cursor: pointer;
      border: none;
      margin-top: -2px;
      position: relative;
      z-index: 3;
	  opacity: 1%; 
    }
	
	.hp-slider-fill {
  background: linear-gradient(to right, crimson 0%, crimson 50%, #333 50%, #333 100%);
}

	.energy-slider-fill {
  background: linear-gradient(to right, #FDA528 0%, #FDA528 50%, #333 50%, #333 100%);
}
	
	.nova-flat-regular {
  		font-family: "Nova Flat", system-ui;
 		font-weight: 400;
  		font-style: normal;
}
	  
    .char-name {
      font-size: 32px;
      font-family: 'Nova Flat', sans-serif;
      font-weight: bold;
      color: whitesmoke;
	  padding: 10px;

    }

    .atr-num-ins {
      background-color: #B73D11;
      font-size: 40px;
      font-family: 'Nova Flat', sans-serif;
      font-weight: bold;
      color: #ffb22e;
      text-align: center;
	  border-radius: 4px;
    }

    .atr-num-sim {
      background-color: #aa1e57;
      font-size: 40px;
      font-family: 'Nova Flat', sans-serif;
      font-weight: bold;
      color: #ef8ec0;
      text-align: center;
		border-radius: 4px;
    }

    .atr-num-raz {
      background-color: #423682;
      font-size: 40px;
      font-family: 'Nova Flat', sans-serif;
      font-weight: bold;
      color: #bfa6ff;
      text-align: center;
		border-radius: 4px;
    }

    .atr-num-mal {
      background-color: #08626D;
      font-size: 40px;
      font-family: 'Nova Flat', sans-serif;
      font-weight: bold;
      color: #46bdc6;
      text-align: center;
		border-radius: 4px;
    }

    .atr {
      font-family: 'Faculty Glyphic', serif;
      text-align: center;
      font-size: 16px;
      color: whitesmoke;
    }

    .atr-num-none {
	  background-color: #222;
      font-size: 36px;
      font-family: 'Nova Flat', sans-serif;
      font-weight: bold;
      color: whitesmoke;
      text-align: center;
		border-radius: 4px;
    }

    .text-hp,
    .text-energy {
      font-size: 16px;
      font-family: 'Nova Flat', sans-serif;
      font-weight: normal;
      color: whitesmoke;
      text-align: center;
    }

    .minititle {
      font-size: 14px;
      font-family: 'Faculty Glyphic', serif;
      text-align: center;
      color: whitesmoke;
    }
	
.cond-obs {
  font-size: 15px;
  font-family: 'Faculty Glyphic', serif;
  color: whitesmoke;
  text-align: center;
  border-radius: 4px;
  background-color: transparent;
  border: none;
  outline: none;
  transition: all 0.3s ease;
}

/* When hovered */
.cond-obs:hover {
  background-color: rgba(255, 255, 255, 0.05); /* subtle highlight */
}

/* When focused (user clicked or is typing) */
.cond-obs:focus {
  border: 1px solid #aaa;
  background-color: rgba(255, 255, 255, 0.08);
}

/* When filled (not empty) */
.cond-obs.filled {
  border: none;
}

	.autocomplete-suggestions div:hover {
  background: #333;
}
	
    .alt-tip {
      background-color: #212f3d;
      color: whitesmoke;
      font-family: 'Faculty Glyphic', serif;
      text-align: center;
      width: 250px;
      border-radius: 4px;
      border: 1px solid whitesmoke;
      padding: 5px;
    }

.button {
  background-color: #222;
  font-size: 15px;
  font-family: 'Faculty Glyphic';
  color: whitesmoke;
  text-align: center;
  border-radius: 4px;
  border: none;
  padding: 5px 10px;
  cursor: pointer;

  transition: background-color 0.2s ease, transform 0.1s ease;
}

.button:hover {
  background-color: #333; /* slightly lighter */
}

.button:active {
  transform: scale(0.96); /* click effect */
}

    .cover-img,
    .img {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .span-ins, .span-sim, .span-raz, .span-mal, .span-none {
      font-size: 10px;
      height: 12px;
      font-family: 'Nova Flat', sans-serif;
      font-weight: bold;
      text-transform: uppercase;
      border-radius: 3px;
      padding: 2px 6px;
      color: white;
      display: flex; flex-wrap: wrap; gap: 6px;
    }

    .span-ins { background-color: #FD7B1F; }
    .span-sim { background-color: #FD42B9; }
    .span-raz { background-color: #856CFC; }
    .span-mal { background-color: #1BC4DA; }
    .span-none { background-color: #616161; }

    /* Classes dinâmicas para elementos com IFs serão sugeridas com sufixos, por exemplo: .text-variable.sim, .text-variable.raz etc */
    .text-variable {
      font-size: 20px;
      font-family: 'Nova Flat', sans-serif;
      font-weight: bold;
      text-align: center;
    }
    .text-variable.ins { color: #FEDDBD; }
    .text-variable.sim { color: #FECDEB; }
    .text-variable.raz { color: #DFD7FE; }
    .text-variable.mal { color: #BDEFF5; }
    .text-variable.none { color: #CECECE; }
	
	.text-variable-emoji {
      font-size: 28px;
      font-family: "NotoEmoji", sans-serif, !important;
      text-align: center;
	}
	.text-variable-emoji.ins { color: #FEDDBD;}
    .text-variable-emoji.sim { color: #FECDEB; }
    .text-variable-emoji.raz { color: #DFD7FE; }
    .text-variable-emoji.mal { color: #BDEFF5; }
    .text-variable-emoji.none { color: #CECECE; }
	
	

	.title {
	  font-size: 14px;
      font-family: 'Faculty Glyphic', serif;
      text-align: center;
      color: whitesmoke;
	  padding: 5px;	  
	  
	}
	.action-variable{
		font-size: 15px;
		text-align: center;
		align-content: center;
		font-family: 'Nova Flat';
		font-weight: 400;	
		
	}
	.action-variable.ins { color: #FD7B1F;}     
	.action-variable.sim { color: #FD42B9;  !important;}
	.action-variable.raz { color: #856CFC;}
	.action-variable.mal { color: #1BC4DA;}
	.action-variable.none { color: #AAA;}
	
    .title-variable {
      font-size: 32px;
      font-family: 'Nova Flat', sans-serif;
      font-weight: bold;
      text-align: center;
    }
    .title-variable.ins { color: #99330C; }
    .title-variable.sim { color: #961A4E; }
    .title-variable.raz { color: #392C78; }
    .title-variable.mal { color: #05525B; }
	.title-variable.none { color: #151515; }

    .sub-variable {
      font-size: 10px;
      font-family: 'Nova Flat', sans-serif;
      text-align: center;
    }
    .sub-variable.ins { color: #FDA528; }
    .sub-variable.sim { color: #FE5FD0; }
    .sub-variable.raz { color: #AD91FD; }
    .sub-variable.mal { color: #23D8E7; }
    .sub-variable.none { color: darkgray; }

    .strong-variable {
      font-size: 12px;
      font-family: 'Faculty Glyphic', serif;
      text-align: center;
	  flex-wrap: wrap;
		
    }
    .strong-variable.ins { color: #FEDDBD; }
    .strong-variable.sim { color: #FECDEB; }
    .strong-variable.raz { color: #DFD7FE; }
    .strong-variable.mal { color: #BDEFF5; }
    .strong-variable.none { color: whitesmoke; }

    .descr-variable {
      font-size: 14px;
      font-family: 'Faculty Glyphic', serif;
      font-weight: bold;
      text-align: center;
    }
    .descr-variable.ins { color: #99330C; !important }         
    .descr-variable.sim { color: #961A4E; !important }
    .descr-variable.raz { color: #392C78; !important }
    .descr-variable.mal { color: #05525B; !important }
    .descr-variable.none { color: #1E1E1E; !important }

    .back-variable.ins { background-color: #B73D11; }
    .back-variable.sim { background-color: #aa1e57; }
    .back-variable.raz { background-color: #423682; }
    .back-variable.mal { background-color: #08626D; }
    .back-variable.none { background-color: #222; }

	.light-div.ins { background-color: #FDA528; }
    .light-div.sim { background-color: #FECDEB; }
    .light-div.raz { background-color: #DFD7FE; }
    .light-div.mal { background-color: #BDEFF5; }
    .light-div.none { background-color: #888; }

    .dark-div.ins { background-color: #99330C; }
    .dark-div.sim { background-color: #961A4E; }
    .dark-div.raz { background-color: #392C78; }
    .dark-div.mal { background-color: #05525B; }
    .dark-div.none { background-color: #1E1E1E; }	
	
	.frame{
		padding: 12px;
		border: 0px solid #555;
		background-color: #222;

	}
	
	/* Right edge cells: show background gap on the right */
.right-gap {
  padding-right: 8px;         /* creates visual gap */
  background-clip: padding-box;
  background-color: inherit;
  background-clip: padding-box;
  border-right: 12px solid transparent;
	}

/* Bottom edge cells: show background gap at the bottom */
.bottom-gap {
  padding-bottom: 8px;
  background-clip: padding-box;
  background-color: inherit;
  background-clip: padding-box;
  border-bottom: 12px solid transparent;
}
	.roll-section {
		table-layout:fixed;
		text-align: center;
		margin-top: 16px;
		background: #151515;
		border-radius: 4px;
		padding: 10px;
		font-family: 'Nova Flat';
		font-size: 20px;
	}
	.roll-formula {
		background: #222;
		padding: 5px;
		padding-left: 14px;
		padding-right: 14px;
		border-radius: 4px;
		font-family: 'Faculty Glyphic';
		font-size: 16px; !important ;
		
	}
	.action-block {
		color: white;
		border-radius: 3px;
		padding: 4px;
		padding-left: 8px;
		padding-right: 8px;
		font-size: 14px;
    cursor: pointer;
    user-select: none;
	}
	
	.action-block.ins { background-color: tomato; }
	.action-block.sim { background-color: deeppink; }
	.action-block.raz { background-color: rebeccapurple; }
	.action-block.mal { background-color: teal; }
	.action-block.none { background-color: #111; }
	
	.individual-result {
		font-size: 18px;
		background: blue;
		padding: 5px;
	}
	.partial-result {
		background: yellow;
	}
	.special-dice-box {
		border: solid 2px gray;
		background: fuchsia;
	}
	.dice-select-block {
		padding: 7px;
		display: flex;
  		flex-direction: column;
  		align-items: center;
		text-align: center;
		vertical-align: center;
	}
	
	.dice-rolling-line {
		display: inline-flex;
		align-items: center;
		padding: 10px;
		gap: 10px;
		
	}
.top-toolbar {
  display: flex;
  justify-content: center;
  gap: 10px;
  background-color: #111;
  padding: 10px 0;
  border-bottom: 1px solid #444;
  position: sticky;
  top: 0;
  z-index: 999;
  margin-bottom: 20px;
}

.top-button {
  font-size: 20px;
  background: #222;
  color: white;
  border: 1px solid #444;
  border-radius: 4px;
  padding: 6px 10px;
  cursor: pointer;
  transition: background 0.3s ease;
}

.top-button:hover {
  background-color: #333;
}

 #event-log-toolbar {
    margin-bottom: 8px;
    background: #222;
    padding: 6px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    font-family: sans-serif;
  }

  #event-log-container {
    max-height: 400px;
    overflow-y: auto;
    background: #222;
    border-radius: 6px;
    padding: 10px;
    font-family: sans-serif;
    display: flex;
    flex-direction: column-reverse;
  }

  .log-entry {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    background: #333;
    padding: 6px;
    border-radius: 4px;
    margin-bottom: 6px;
    border-left: 5px solid #ddd;
  }
  .log-entry .log-content {
    flex-grow: 1;
    font-size: 14px;
    white-space: pre-wrap;
  }

  .log-entry textarea {
    width: 100%;
    min-height: 60px;
  }

  .log-entry input[type="checkbox"] {
    margin-top: 6px;
  }

  .log-entry .log-status {
    margin-top: 6px;
  }

  .hidden-log {
    display: none;
  }
	
	#spells-area {
  padding: 10px;
  border: 1px solid #444;
  margin-top: 6px;
}
 .spell-container {
  margin-top: 15px;
  margin-bottom: 15px;
  display: flex;
  width: fit-content;
    
}
.spell-side {
  background: #1b1b1b;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #444;
}
	
	.spells-action-container span {
	display: inline-block;   /* ou inline-flex */
  margin: 0 4px;	
	}
	
</style>
</head>
<body>
<div id="save-indicator" style="
  position: fixed;
  top: 12px;
  right: 16px;
  background: #222;
  padding: 8px 12px;
  font-size: 16px;
  font-family: 'Nova Flat', sans-serif;
  color: white;
  border: 1px solid #555;
  border-radius: 6px;
  z-index: 9999;
  box-shadow: 0 0 8px rgba(0,0,0,0.3);
">☁️ Aguardando...</div>
<div class="top-toolbar" id="top-bar">
<button class="top-button" id="toggle-spells" onclick="toggleSpellSection()" title="Feitiços">🪄</button>
<button class="top-button" id="calculator-button" onclick="window.open('difficulty_calculator.html', 'CalculadoraDeDificuldade', 'width=1000,height=700,resizable=yes,scrollbars=yes')" title="Calculadora de Dificuldade">🧮</button>
<button class="top-button" title="Relacionamentos">💞</button>
<button class="top-button" title="Aprendizados">📚</button>
<button class="top-button" onclick="window.open('uso_ambiente.html', 'UsoDoAmbiente', 'width=1000,height=700,resizable=yes,scrollbars=yes')" title="Uso do ambiente">🌎</button>
<button class="top-button" title="Inventário">🎒</button>
<button class="top-button" title="Filtro de Ações">❓</button>
</div>
<center><div class="spell-container" id="spells-area">
<div style="display: grid; grid-template-columns: 880px 880px; gap: 30px; justify-content: center;">
<!-- Lado A -->
<div class="spell-side" id="spells-a" style="flex: 1;"></div>
<!-- Lado B -->
<div class="spell-side" id="spells-b" style="flex: 1;"></div>
</div>
</div></center>
<!-- Script para autocomplete e preenchimento -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import {
  getFirestore,
  collection,
  doc,
  getDoc,
  getDocs,
  updateDoc,
  setDoc,
  onSnapshot,
  addDoc,
  deleteDoc,
  query,
  orderBy,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCoO7sYTOcz_1JrW46VoRowvHYa5wUFSTk",
  authDomain: "rpg-prisma-f5a11.firebaseapp.com",
  projectId: "rpg-prisma-f5a11",
  storageBucket: "rpg-prisma-f5a11.firebasestorage.app",
  messagingSenderId: "65278749627",
  appId: "1:65278749627:web:804f5d41adbab5351e729e"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let charData = [], actionData = [], spellsData = [], conditionsData = [];
let spellsList = [];

// Make variables globally accessible
window.charData = charData;
window.actionData = actionData;
window.spellsData = spellsData;
window.conditionsData = conditionsData;
window.spellsList = spellsList;

// Define constants and field mappings
const charFields = [
  "char_avatar", "char_name", "char_player", "char_hp", "char_maxhp", "char_energy", "char_maxenergy",
  "char_ins", "char_sim", "char_raz", "char_mal", "char_por", "char_ndf", "char_agi",
  "char_bonus1", "char_bonus2", "char_bonus3", "char_bonus4", "char_bonus5", "char_bonus6",
  "char_deduc1", "char_deduc2", "char_deduc3", "char_passiveperc", "char_narrativepoints"
];
const actionFields = [
  "action_formula_lit", "att", "selected_att_label", "diceamount_label", "fixedbonus_label", 
  "img_action", "img_action_type", "action_type", "action_energy", "action_type1", "action_type2", "action_type3", "action_group_possib",
  "att_img", "counter", "has_bonus", "opp_has_bonus", "action_description", "action_condition"
];

// Keyword-to-attribute mapping
const keywordToAttr = {
  // INS
  "ATACAR": "ins", "BLOQUEAR, CONTRA-ATACAR": "ins", "INTERROMPER": "ins", "RESISTIR IMPACTO": "ins",
  "ARREMESSAR": "ins", "CARREGAR, FORÇA": "ins", "ESCALAR": "ins", "INICIATIVA, ALCANÇAR": "ins",
  "INTIMIDAR": "ins", "DESAFIAR": "ins", "FORÇA DE VONTADE": "ins", "ORIENTAÇÃO, SOBREVIVÊNCIA": "ins", "CLARIVIDÊNCIA": "ins",
  // SIM
  "PROTEGER OUTREM": "sim", "CURAR": "sim", "PERSUADIR": "sim", "BARGANHAR": "sim", "SEDUZIR": "sim", "INSPIRAR": "sim",
  "IMPLORAR": "sim", "ACALMAR": "sim", "DOMAR, TREINAR": "sim", "CONTATOS": "sim", "RELAÇÃO": "sim", "SENSIBILIDADE": "sim", "LIDERAR, COORDENAR": "sim",
  // RAZ
  "MIRAR": "raz", "PROTEGER-SE": "raz", "FOCAR": "raz", "ENFEITIÇAR, DESENFEITIÇAR": "raz", "TRANSFORMAR": "raz", "CONFECCIONAR, REPARAR": "raz",
  "PERCEPÇÃO": "raz", "INVESTIGAÇÃO": "raz", "OCLUMÊNCIA": "raz", "BUSCAR": "raz", "APRENDER": "raz", "CONHECIMENTO": "raz", "RESOLVER ENIGMA": "raz",
  // MAL
  "MALDIÇÃO, INFLIGIR DOR": "mal", "AZARAR": "mal", "DESVIAR": "mal", "EMBOSCAR": "mal", "SURPREENDER": "mal", "DISTRAIR": "mal",
  "FUGIR": "mal", "ENGANAR": "mal", "MANIPULAR": "mal", "RESISTIR SÚPLICA": "mal", "FURTIVIDADE": "mal", "ROUBAR, PLANTAR": "mal", "MANUSEAR": "mal"
};

function setFields(charRow, actionRow, suffix) {
  // Set attribute name
  const selectedAttNameEl = document.getElementById("selected_att_name" + suffix);
  if (selectedAttNameEl) {
    selectedAttNameEl.textContent = actionRow && actionRow.att ? actionRow.att.trim() : "";
  }

  // Populate character fields
  charFields.forEach(f => {
    const el = document.getElementById(f + suffix);
    if (el) {
      const value = charRow && charRow[f] ? charRow[f] : "";
      if (el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
        el.value = value;
      } else {
        el.textContent = value;
      }
    }
  });

  // Immediately after populating charFields, update the class for bonuses and deductions
  for (let i = 1; i <= 6; ++i) {
    const el = document.getElementById(`char_bonus${i}${suffix}`);
    if (!el) continue;
    const val = el.textContent.trim().toUpperCase();
    el.classList.remove('ins', 'sim', 'raz', 'mal', 'none');
    el.classList.add(keywordToAttr[val] || 'none');
  }
  for (let i = 1; i <= 3; ++i) {
    const el = document.getElementById(`char_deduc${i}${suffix}`);
    if (!el) continue;
    const val = el.textContent.trim().toUpperCase();
    el.classList.remove('ins', 'sim', 'raz', 'mal', 'none');
    el.classList.add(keywordToAttr[val] || 'none');
  }

  // Populate action fields
  actionFields.forEach(f => {
    const el = document.getElementById(f + suffix);
    if (el) el.textContent = actionRow && actionRow[f] ? actionRow[f] : "";
  });

  // Override and format counter separately (now that it's always an array)
  const counterEl = document.getElementById("counter" + suffix);
  if (counterEl && actionRow && actionRow.counter) {
    counterEl.innerHTML = renderCounterSpans(actionRow.counter, suffix);
  }

  // Set attribute label and value
  const attLabelEl = document.getElementById("selected_att_label" + suffix);
  if (attLabelEl) attLabelEl.textContent = actionRow && actionRow.att ? actionRow.att.trim() : "";

  let statVal = "-";
  if (actionRow && actionRow.att) {
    const statCode = actionRow.att.trim().toLowerCase();
    const charSel = document.getElementById(`char-select${suffix}`);
    const charId = charSel.value;
    const charRow = charData.find(c => c.id === charId);
    if (charRow && charRow["char_" + statCode] !== undefined) {
      statVal = charRow["char_" + statCode];
    }
  }
  const attValEl = document.getElementById("selected_att" + suffix);
  if (attValEl) attValEl.textContent = statVal;
}

function renderCounterSpans(counterArr, suffix) {
  if (!counterArr || !counterArr.length) return "";
  return counterArr.map(actionName => {
    const clean = actionName.trim();
    const attr = keywordToAttr[clean.toUpperCase()] || "none";
    return `<span class="action-block ${attr} counter-action-btn" data-action="${clean}" data-side="${suffix === '-a' ? 'b' : 'a'}">${clean}</span>`;
  }).join(" ");
}

function setupConditionsAutocomplete(side) {
  const input = document.getElementById(`cond-${side}`);
  const listId = `cond-autocomplete-list-${side}`;

  input.addEventListener("input", function() {
    // Remove any old autocomplete
    let old = document.getElementById(listId);
    if (old) old.remove();

    const val = input.value.toLowerCase();
    if (!val || !window.conditionsData) return;

    const matches = window.conditionsData.filter(c =>
      c.condition && c.condition.toLowerCase().includes(val)
    );

    if (!matches.length) return;

    const list = document.createElement("div");
    list.id = listId;
    list.style.position = "absolute";
    list.style.background = "#222";
    list.style.zIndex = 10;
    list.style.border = "1px solid #333";
    list.style.maxHeight = "140px";
    list.style.overflowY = "auto";
    list.style.width = input.offsetWidth + "px";
    list.style.left = input.getBoundingClientRect().left + "px";
    list.style.top = (input.getBoundingClientRect().bottom + window.scrollY) + "px";

    matches.forEach(cond => {
      const option = document.createElement("div");
      option.textContent = cond.condition;
      option.style.padding = "4px 8px";
      option.style.cursor = "pointer";
     option.title = `${cond.cond_category || ""}: ${cond.cond_description || ""}\nEFEITO: ${cond.cond_effects || ""}`;
console.log("Setting tooltip for", cond.condition, "=", option.title);

      
      option.onclick = () => {
        input.value = cond.condition;
        list.remove();
      };
      list.appendChild(option);
    });

    document.body.appendChild(list);

    // Remove autocomplete when clicking outside
    document.addEventListener("click", function onDocClick(e) {
      if (e.target !== input) {
        if (document.getElementById(listId)) document.getElementById(listId).remove();
        document.removeEventListener("click", onDocClick);
      }
    });
  });
}

// Make function globally accessible
window.setupConditionsAutocomplete = setupConditionsAutocomplete;


function setupCharacterListeners() {
  let charListenerA = null;
  let charListenerB = null;

  function setupCharListener(side) {
    const charSelect = document.getElementById(`char-select-${side}`);
    const charId = charSelect.value;
    
    if (!charId) return;

    // Remove previous listener if exists
    if (side === "a" && charListenerA) {
      charListenerA();
      charListenerA = null;
    }
    if (side === "b" && charListenerB) {
      charListenerB();
      charListenerB = null;
    }

    // Setup new listener
    const charRef = doc(db, "campaigns", "alpha", "characters_range", charId);
    const unsubscribe = onSnapshot(charRef, (doc) => {
      if (doc.exists()) {
        const data = doc.data();
        
        // Update all character fields
        charFields.forEach(field => {
          const el = document.getElementById(`${field}-${side}`);
          if (el && data[field] !== undefined) {
            if (el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
              el.value = data[field];
            } else {
              el.textContent = data[field];
            }
          }
        });

        // Update sliders
        updateStatRanges(side);
        
        // Update condition tags from char_cond field
        if (data.char_cond) {
          updateConditionTags(side, data.char_cond);
        }
        
        // Apply bonus/deduction styling
        applyBonusDeductionStyling(side);
      }
    });

    // Store the unsubscribe function
    if (side === "a") {
      charListenerA = unsubscribe;
    } else {
      charListenerB = unsubscribe;
    }
  }

  // Setup initial listeners
  setupCharListener("a");
  setupCharListener("b");

  // Add listeners to dropdown changes
  document.getElementById("char-select-a").addEventListener("change", () => setupCharListener("a"));
  document.getElementById("char-select-b").addEventListener("change", () => setupCharListener("b"));
}

function applyBonusDeductionStyling(side) {
  const suffix = side === 'a' ? '-a' : '-b';
  
  // Apply styling to bonus fields
  for (let i = 1; i <= 6; ++i) {
    const el = document.getElementById(`char_bonus${i}${suffix}`);
    if (!el) continue;
    const val = el.textContent.trim().toUpperCase();
    el.classList.remove('ins', 'sim', 'raz', 'mal', 'none');
    el.classList.add(keywordToAttr[val] || 'none');
  }
  
  // Apply styling to deduction fields
  for (let i = 1; i <= 3; ++i) {
    const el = document.getElementById(`char_deduc${i}${suffix}`);
    if (!el) continue;
    const val = el.textContent.trim().toUpperCase();
    el.classList.remove('ins', 'sim', 'raz', 'mal', 'none');
    el.classList.add(keywordToAttr[val] || 'none');
  }
}

function showSaveIndicator(message) {
  const indicator = document.getElementById("save-indicator");
  if (indicator) {
    indicator.textContent = message;
    setTimeout(() => {
      indicator.textContent = "☁️ Aguardando...";
    }, 2000);
  }
}

function setupDropdowns() {
  const charSelA = document.getElementById("char-select-a");
  const charSelB = document.getElementById("char-select-b");
  const actSelA = document.getElementById("action-select-a");
  const actSelB = document.getElementById("action-select-b");

charSelA.innerHTML = charData.map(row => `<option class="option" value="${row.id}">${row.char_name}</option>`).join('');
charSelB.innerHTML = charData.map(row => `<option class="option" value="${row.id}">${row.char_name}</option>`).join('');

  actSelA.innerHTML = actionData.map((row, i) => `<option class="option" value="${i}">${row.action}</option>`).join('');
  actSelB.innerHTML = actionData.map((row, i) => `<option class="option" value="${i}">${row.action}</option>`).join('');

  async function updateSessionState() {
    try {
      const sessionStateRef = doc(db, "campaigns", "alpha", "session_state", "main");
      await updateDoc(sessionStateRef, {
        charA: charSelA.value,
        charB: charSelB.value,
        actionA: actSelA.value,
        actionB: actSelB.value
      });
      showSaveIndicator("☁️ Sincronizado");
    } catch (error) {
      // If document doesn't exist, create it
      if (error.code === 'not-found') {
        try {
          await setDoc(sessionStateRef, {
            charA: charSelA.value,
            charB: charSelB.value,
            actionA: actSelA.value,
            actionB: actSelB.value
          });
          showSaveIndicator("☁️ Sincronizado");
        } catch (createError) {
          console.error("Error creating session state:", createError);
          showSaveIndicator("❌ Erro");
        }
      } else {
        console.error("Error updating session state:", error);
        showSaveIndicator("❌ Erro");
      }
    }
  }

function refreshA() {
  setFields(charData[charSelA.value], actionData[actSelA.value], "-a");
  updatePartialResult("a");
  updateStatRanges("a");
  setTimeout(() => {
    applyActionVariableClasses("a");
    applySimpleVariableClassesFromField("a");
    setupDiceSection("a");
  }, 30);
}
function refreshB() {
  setFields(charData[charSelB.value], actionData[actSelB.value], "-b");
  updatePartialResult("b");
  updateStatRanges("b");
  setTimeout(() => {
    applyActionVariableClasses("b");
    applySimpleVariableClassesFromField("b");
    setupDiceSection("b");
  }, 30);
}

  
  charSelA.onchange = () => {
    refreshA();
    updateSessionState();
  };
  actSelA.onchange = () => {
    refreshA();
    updateSessionState();
  };
  charSelB.onchange = () => {
    refreshB();
    updateSessionState();
  };
  actSelB.onchange = () => {
    refreshB();
    updateSessionState();
  };

  refreshA();
  refreshB();
}

["char_hp", "char_energy", "char_narrativepoints"].forEach(field => {
  setupLiveCharField(field, "a", "input", x => parseInt(x) || 0);
  setupLiveCharField(field, "b", "input", x => parseInt(x) || 0);
});
["char_obs"].forEach(field => {
  setupLiveCharField(field, "a", "input");
  setupLiveCharField(field, "b", "input");
});

	
function applyActionVariableClasses(groupSuffix = 'a') {
  // This function would need the action data to determine classes
  // For now, keeping it as a placeholder
}

function applySimpleVariableClassesFromField(groupSuffix = 'a') {
  const attrEl = document.getElementById(`selected_att_name-${groupSuffix}`);
  if (!attrEl) return;

  const attrRaw = attrEl.textContent.trim().toUpperCase();
  const att = ['INS', 'SIM', 'RAZ', 'MAL'].includes(attrRaw) ? attrRaw : 'NONE';

  const classTypes = [
    'title-variable', 'sub-variable',
    'descr-variable', 'strong-variable',
    'back-variable', 'light-div', 'dark-div', 'text-variable', 'text-variable-emoji'
  ];

  classTypes.forEach(classType => {
    const elements = document.querySelectorAll(`.${classType}[id$="-${groupSuffix}"]`);
    elements.forEach(el => {
      el.classList.remove('ins', 'sim', 'raz', 'mal', 'none');
      el.classList.add(att.toLowerCase());
    });
  });
}

function getActionAttrKey(actionRow) {
  if (!actionRow) return "";
  return (actionRow.att || "").toLowerCase();
}

// --- DICE LOGIC PATCH ---
function setupDiceSection(side) {
  // ... existing setup code for dice, etc. ...

  document.getElementById('rollalldice-' + side).onclick = async function () {
    const mainDice = Math.max(1, parseInt(document.getElementById('diceamount-' + side).value) || 1);
    const mainBonus = parseInt(document.getElementById('fixedbonus-' + side).value) || 0;
    const attVal = parseInt(document.getElementById('selected_att-' + side).textContent) || 0;

    let rolls = [];
    for (let i = 0; i < mainDice; ++i) {
      rolls.push(Math.floor(Math.random() * 4));
    }
    let sum = rolls.reduce((a, b) => a + b, 0);
    let total = attVal + mainBonus + sum;

    // Create breakdown list (HTML)
    let breakdown = [
      `<span class="partial-result" title="Atributo Base"><b>${attVal}</b></span>`,
      `<span class="partial-result" title="Bônus Fixo"><b>${mainBonus}</b></span>`,
      ...rolls.map(r => `<span class="partial-result" title="Dado Padrão 0-3"><b>${r}</b></span>`)
    ];

    // Handle special dice
    let specialTotal = 0;
    const specialArea = document.getElementById('specialdice_area-' + side);
    specialArea.querySelectorAll('.dice-group').forEach(group => {
      const amount = parseInt(group.querySelector('.special-amount').value) || 1;
      const max = parseInt(group.querySelector('.special-max').value);
      const min = parseInt(group.querySelector('.special-min').value);
      for (let j = 0; j < amount; ++j) {
        const r = Math.floor(Math.random() * (max - min + 1)) + min;
        breakdown.push(`<span class="partial-result" title="Dado Especial ${min}-${max}*"><b>${r}</b></span>`);
        specialTotal += r;
      }
    });

    const finalSum = total + specialTotal;
    const breakdownHTML = breakdown.join(" + ");

    // Output to UI
    document.getElementById('roll_breakdown-' + side).innerHTML = breakdownHTML;
    document.getElementById('roll_result-' + side).innerHTML = `<br><span class="individual-result"><b>${finalSum}</b></span>`;

    // --- NEW: Sync to Firebase session_state/main ---
    try {
      const sessionStateRef = doc(db, "campaigns", "alpha", "session_state", "main");
      const updateData = {};
      if (side === 'a') {
        updateData['aBreakdown'] = breakdownHTML;
        updateData['aResult'] = finalSum;
      } else {
        updateData['bBreakdown'] = breakdownHTML;
        updateData['bResult'] = finalSum;
      }
      await updateDoc(sessionStateRef, updateData);
      showSaveIndicator("☁ Resultado sincronizado");
    } catch (error) {
      // If the doc doesn't exist, try to create it
      if (error.code === "not-found") {
        await setDoc(sessionStateRef, updateData);
      } else {
        console.error("Erro ao sincronizar resultado no Firestore:", error);
      }
    }
  };
}

function updatePartialResult(side) {
  const att = parseInt(document.getElementById('selected_att-' + side).textContent) || 0;
  const bonus = parseInt(document.getElementById('fixedbonus-' + side).value) || 0;
  const partial = att + bonus;
  document.getElementById('partialresult-' + side).textContent = partial;
  document.getElementById('partialresult_log-' + side).textContent = partial;
}

function updateStatRanges(side) {
  // HP - read from input field
  const hpEl = document.getElementById('char_hp-' + side);
  const hp = parseInt(hpEl.tagName === "INPUT" ? hpEl.value : hpEl.textContent) || 0;
  const maxhp = parseInt(document.getElementById('char_maxhp-' + side).textContent) || 1;
  const hpRange = document.getElementById('char_hp_range-' + side);
  hpRange.min = 0;
  hpRange.max = maxhp;
  hpRange.value = hp;
  hpRange.style.accentColor = "crimson";
  hpRange.classList.add("hp-slider-fill");
  updateSliderFill(hpRange, "crimson");
  hpRange.oninput = function () {
    const hpInput = document.getElementById('char_hp-' + side);
    if (hpInput.tagName === "INPUT") {
      hpInput.value = this.value;
    } else {
      hpInput.textContent = this.value;
    }
    updateSliderFill(this, "crimson");
  };

onSnapshot(doc(db, "campaigns", "alpha", "session_state", "main"), (docSnap) => {
  if (!docSnap.exists()) return;
  const data = docSnap.data();
  if (data.aBreakdown !== undefined)
    document.getElementById("roll_breakdown-a").innerHTML = data.aBreakdown;
  if (data.bBreakdown !== undefined)
    document.getElementById("roll_breakdown-b").innerHTML = data.bBreakdown;
  if (data.aResult !== undefined)
    document.getElementById("roll_result-a").innerHTML = `<br><span class="individual-result"><b>${data.aResult}</b></span>`;
  if (data.bResult !== undefined)
    document.getElementById("roll_result-b").innerHTML = `<br><span class="individual-result"><b>${data.bResult}</b></span>`;
});
	
  // Energy - read from input field
  const energyEl = document.getElementById('char_energy-' + side);
  const energy = parseInt(energyEl.tagName === "INPUT" ? energyEl.value : energyEl.textContent) || 0;
  const maxenergy = parseInt(document.getElementById('char_maxenergy-' + side).textContent) || 1;
  const energyRange = document.getElementById('char_energy_range-' + side);
  energyRange.min = 0;
  energyRange.max = maxenergy;
  energyRange.value = energy;
  energyRange.style.accentColor = "#FDA528";
  energyRange.classList.add("energy-slider-fill");
  updateSliderFill(energyRange, "#FDA528");
  energyRange.oninput = function () {
    const energyInput = document.getElementById('char_energy-' + side);
    if (energyInput.tagName === "INPUT") {
      energyInput.value = this.value;
    } else {
      energyInput.textContent = this.value;
    }
    updateSliderFill(this, "#FDA528");
  };
}

// PRESERVE FUNCTION FOR RANGE FIELDS //
function setCenteredGradient(slider, colorLeft, colorRight) {
  const value = parseInt(slider.value, 10);
  const percent = (Math.abs(value) / 3) * 50;

  let backgroundFill;

  if (value > 0) {
    backgroundFill = `linear-gradient(to right, 
      transparent 50%, 
      ${colorRight} 50%, 
      ${colorRight} ${50 + percent}%, 
      transparent ${50 + percent}%)`;
  } else if (value < 0) {
    backgroundFill = `linear-gradient(to right, 
      transparent ${50 - percent}%, 
      ${colorLeft} ${50 - percent}%, 
      ${colorLeft} 50%, 
      transparent 50%)`;
  } else {
    backgroundFill = `transparent`;
  }

  const base = `repeating-linear-gradient(
    to right,
    #222,
    #222 calc((100% / 6) - 3px),
    transparent calc((100% / 6) - 3px),
    transparent calc(100% / 6)
  )`;

  slider.style.background = backgroundFill !== 'transparent'
    ? `${backgroundFill}, ${base}`
    : base;
}

const sliders = [
  { id: 'char_fear_anger-a', left: '#08626D', right: '#B73D11' },
  { id: 'char_distrust_trust-a', left: '#423682', right: '#aa1e57' },
  { id: 'char_stress_calm-a', left: '#B73D11', right: '#423682' },
  { id: 'char_guilt_satisf-a', left: '#aa1e57', right: '#08626D' },
  { id: 'char_fear_anger-b', left: '#08626D', right: '#B73D11' },
  { id: 'char_distrust_trust-b', left: '#423682', right: '#aa1e57' },
  { id: 'char_stress_calm-b', left: '#B73D11', right: '#423682' },
  { id: 'char_guilt_satisf-b', left: '#aa1e57', right: '#08626D' }
];

sliders.forEach(({ id, left, right }) => {
  const slider = document.getElementById(id);
  setCenteredGradient(slider, left, right);
  slider.addEventListener('input', () => {
    setCenteredGradient(slider, left, right);
  });
});

function updateSliderFill(slider, color) {
  const value = (slider.value - slider.min) / (slider.max - slider.min);
  const percent = value * 100;
  slider.style.background = `linear-gradient(to right, ${color} 0%, ${color} ${percent}%, #333 ${percent}%, #333 100%)`;
}

document.getElementById("obs-toggle-a").addEventListener("click", function () {
  const obsField = document.getElementById("obs-field-a");
  if (obsField) {
    const isVisible = obsField.style.display !== "none";
    obsField.style.display = isVisible ? "none" : "block";
  }	
});

document.getElementById("obs-toggle-b").addEventListener("click", function () {
  const obsField = document.getElementById("obs-field-b");
  if (obsField) {
    const isVisible = obsField.style.display !== "none";
    obsField.style.display = isVisible ? "none" : "block";
  }
});

document.getElementById("rollalldice-b").addEventListener("click", () => {
  // Supondo que sua lógica de rolagem já esteja aqui...
  // Agora adicionamos o envio do popup com log de confirmação:

  setTimeout(() => {
    const popup = window.open("event_log_window.html", "LogPopup", "width=1060,height=630");

    setTimeout(() => {
      const charAData = getCharacterData("a");
      const charBData = getCharacterData("b");

      console.log("✅ Enviando dados para o popup:", {
        charA: charAData,
        charB: charBData,
      });

      popup.postMessage({
        charA: charAData,
        charB: charBData, 
      }, "*");
    }, 500);
  }, 1000);
});

function safeText(id) {
  const el = document.getElementById(id);
  return el ? el.textContent.trim() : "❓";
}

function safeNumber(id) {
  const el = document.getElementById(id);
  return el ? parseInt(el.textContent.trim() || "0") : 0;
}

function getCharacterData(side) {
  // ID reverso do adversário
  const other = side === "a" ? "b" : "a";

  const nameSelect = document.getElementById(`char-select-${side}`);
  const name = nameSelect?.options[nameSelect.selectedIndex]?.textContent.trim() || "❓";

  const targetSelect = document.getElementById(`char-select-${side === "a" ? "b" : "a"}`);
  const target = targetSelect?.options[targetSelect.selectedIndex]?.textContent.trim() || "❓";

  const action = document.getElementById(`action-select-${side}`)?.selectedOptions?.[0]?.textContent || "❓";
  const atr = document.getElementById(`selected_att_name-${side}`)?.textContent || "??";

  const bonus = parseInt(document.getElementById(`fixedbonus-${side}`)?.textContent || "0");
  const bonus_reason = "";

  // Resultado total
  const result = parseInt(document.getElementById(`roll_result-${side}`)?.textContent || "0");

  // Energia e HP atual
  const current_hp = parseInt(document.getElementById(`char_hp-${side}`)?.textContent || "0");
  const current_en = parseInt(document.getElementById(`char_energy-${side}`)?.textContent || "0");

  // Alterações de energia e HP (só para simular no log)
  const altered_hp = 0;
  const altered_en = parseInt(document.getElementById(`action_energy-${side}`)?.textContent || "0");

  // Breakdown com os tooltips
  const breakdown = Array.from(document.querySelectorAll(`#roll_breakdown-${side} span[title]`)).map(span => ({
    label: span.getAttribute("title"),
    value: parseInt(span.textContent) || 0
  }));
  
  // Ndf
  const ndfEl = document.getElementById(`char_ndf-${side}`);
  const ndf = ndfEl ? parseInt(ndfEl.textContent.trim()) || 0 : 0;
  
  const spell_dmg_el = document.getElementById(`spell_dmg-${side}`);
  const spell_dmg = spell_dmg_el ? spell_dmg_el.textContent.trim() : "";

  const spell_effect_condition = document.getElementById(`spell_effect_condition-${side}`)?.textContent || "";
  const spell_extra_condition = document.getElementById(`spell_extra_condition-${side}`)?.textContent || "";

  return {
    name,
    target,
    action,
    atr,
    bonus,
    bonus_reason,
    breakdown,
    result,
    altered_hp,
    altered_en,
    current_hp,
    current_en,
    ndf,
    spell_dmg,
    spell_effect_condition,
    spell_extra_condition,
  };
}

function sendLogPopupData() {
  const popup = window.open("event_log_window.html", "LogPopup", "width=1060,height=630");

  const dataA = getCharacterData("a");
  const dataB = getCharacterData("b");

  setTimeout(() => {
    popup.postMessage({
      charA: dataA,
      charB: dataB,
      action: dataA.action,
      attribute: dataA.atr
    }, "*");
  }, 500);
}

// --- Event Log Live Sync (copy-paste this at end of your script) ---

function getFormattedTimestamp(date = new Date()) {
  // Ensures consistent timestamp formatting (dd/MMM/yy HH:mm:ss)
  if (!(date instanceof Date)) date = new Date(date);
  const day = String(date.getDate()).padStart(2, "0");
  const mon = date.toLocaleString("en", { month: "short" });
  const year = String(date.getFullYear()).slice(-2);
  const hour = String(date.getHours()).padStart(2, "0");
  const min = String(date.getMinutes()).padStart(2, "0");
  const sec = String(date.getSeconds()).padStart(2, "0");
  return `${day}/${mon}/${year} ${hour}:${min}:${sec}`;
}

// Renders ONE log entry, with all checkboxes, and manual-done-hidden handling
function renderFirebaseLogEntry(logData, logId) {
  const container = document.getElementById("event-log-container");
  if (!container) return;

  // Build row
  const row = document.createElement("div");
  row.className = "log-entry";
  row.dataset.logId = logId || "";

  // Selection checkbox (for hide/delete)
  const selectBox = document.createElement("input");
  selectBox.type = "checkbox";
  selectBox.className = "log-select";

  // Timestamp
  const timestamp = logData.timestamp 
    ? getFormattedTimestamp(logData.timestamp.toDate ? logData.timestamp.toDate() : logData.timestamp)
    : getFormattedTimestamp();
  const timeDiv = document.createElement("div");
  timeDiv.className = "log-timestamp";
  timeDiv.style = "width:120px; font-size:11px; color:#666; margin-top:6px;";
  timeDiv.textContent = timestamp;

  // Content
  const contentDiv = document.createElement("div");
  contentDiv.className = "log-content";
  contentDiv.innerHTML = logData.content || "";

  // Done/Not done checkbox
  const statusBox = document.createElement("input");
  statusBox.type = "checkbox";
  statusBox.className = "log-status";
  statusBox.title = "Feito";
  statusBox.checked = !!logData.done;

  // Restore hidden status
  if (logData.hidden) row.classList.add("hidden-log");

  // Toggle done status
  statusBox.addEventListener("change", async () => {
    const db = window.db || getFirestore();
    const logRef = doc(db, "campaigns", "alpha", "event_log_range", logId);
    await updateDoc(logRef, { done: statusBox.checked });
  });

  // Hidden/visible handled by button elsewhere

  // Compose row
  row.appendChild(selectBox);
  row.appendChild(timeDiv);
  row.appendChild(contentDiv);
  row.appendChild(statusBox);

  // Prepend to ensure newest-on-top
  container.appendChild(row);
}

// --- Event Log Live Sync (listener, don't duplicate imports/collections) ---
const eventLogColl = collection(db, "campaigns", "alpha", "event_log_range");
const logQuery = query(eventLogColl, orderBy("timestamp", "desc")); // newest first

onSnapshot(logQuery, (snapshot) => {
  const container = document.getElementById("event-log-container");
  container.innerHTML = ""; // Clear log display

  snapshot.forEach(docSnap => {
    renderFirebaseLogEntry(docSnap.data());
  });
});

	
// Drop-in function to add log entries both to the UI and Firebase
async function addLogEntry(entry, isManual = false) {
  try {
    // Use timestamp + random for document ID
    const now = new Date();
    const timestamp = now.getTime();
    const random = Math.random().toString(36).substring(2, 7);
    const docId = `${timestamp}_${random}`;
    await setDoc(doc(eventLogColl, docId), {
      content: entry,
      timestamp: now,
      manual: isManual
    });
  } catch (error) {
    console.error("Erro ao salvar log no Firebase:", error);
  }
}
// Make sure global (for window.addLogEntry)
window.addLogEntry = addLogEntry;


// Recebe logs vindos do popup
window.addEventListener("message", (event) => {
  console.log("Recebido log do popup:", event.data);
  if (!event.data || !event.data.logs) return;
  event.data.logs.forEach(log => addLogEntry(log));
});

// 🧩 Torna editável novamente
function makeContentEditable(container, value) {
  container.innerHTML = "";
  const textarea = document.createElement("textarea");
  textarea.value = value;
  textarea.onblur = () => {
    container.innerHTML = textarea.value;
  };
  container.appendChild(textarea);
  textarea.focus();
}

// Util: Generate unique ID (could use push from firebase, but here's a fallback)
function logId() {
  return String(Date.now()) + '-' + Math.floor(Math.random() * 10000);
}

// Render the log from a sorted array of entries
function renderEventLog(logArray) {
  const container = document.getElementById("event-log-container");
  container.innerHTML = "";
  logArray.forEach(log => {
    const row = document.createElement("div");
    row.className = "log-entry";
    if (log.hidden) row.classList.add("hidden-log");

    // Checkbox for selection
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.className = "log-select";
    checkbox.dataset.id = log.id;

    // Timestamp
    const timestampDiv = document.createElement("div");
    timestampDiv.className = "log-timestamp";
    timestampDiv.style = "width: 120px; font-size: 11px; color: #666; margin-top: 6px;";
    timestampDiv.textContent = new Date(log.timestamp).toLocaleString();

    // Content (editable for manual logs)
    const contentDiv = document.createElement("div");
    contentDiv.className = "log-content";
    contentDiv.innerHTML = log.content;
    contentDiv.dataset.id = log.id;
    contentDiv.contentEditable = !!log.manual;
    contentDiv.style.background = log.manual ? "#262626" : "none";
    contentDiv.addEventListener("blur", async (e) => {
      if (!log.manual) return;
      const newText = contentDiv.innerText.trim();
      await updateDoc(doc(eventLogColl, log.id), { content: newText });
    });

    // Status "done"
    const statusCheckbox = document.createElement("input");
    statusCheckbox.type = "checkbox";
    statusCheckbox.className = "log-status";
    statusCheckbox.checked = !!log.done;
    statusCheckbox.title = "Feito";
    statusCheckbox.addEventListener("change", () => {
      updateDoc(doc(eventLogColl, log.id), { done: statusCheckbox.checked });
    });

    row.appendChild(checkbox);
    row.appendChild(timestampDiv);
    row.appendChild(contentDiv);
    row.appendChild(statusCheckbox);

    container.prepend(row); // newest on top
  });
}

// Global: keep the log array in memory
let currentLogArray = [];

// ---- REALTIME FIREBASE LISTENER ----
function setupLogRealtimeListener() {
  const q = query(eventLogColl, orderBy("timestamp", "desc"));
  onSnapshot(q, (snap) => {
    currentLogArray = [];
    snap.forEach(doc => currentLogArray.push({ id: doc.id, ...doc.data() }));
    renderEventLog(currentLogArray);
  });
}
setupLogRealtimeListener();

// ---- BUTTON/CONTROL HOOKS ----
document.querySelector("#event-log-toolbar .button[onclick*='addManualLog']").onclick = addManualLog;
document.querySelector("#event-log-toolbar .button[onclick*='addTurnChange']").onclick = addTurnChangeLog;
document.querySelector("#event-log-toolbar .button[onclick*='deleteSelectedLogs']").onclick = deleteSelectedLogs;
document.querySelector("#event-log-toolbar .button[onclick*='toggleVisibility']").onclick = toggleVisibility;
document.getElementById("status-filter").onchange = filterStatusLogs;

// ---- FUNCTIONS ----
async function addManualLog() {
  const entry = {
    content: "Clique aqui e digite seu log...",
    manual: true,
    hidden: false,
    done: false,
    timestamp: Date.now(),
  };
  await addDoc(eventLogColl, entry);
}

async function addTurnChangeLog() {
  // Use current turn from the input
  const turnInput = document.getElementById("current-turn");
  const turno = parseInt(turnInput.value) || 1;
  await addDoc(eventLogColl, {
    content: `📢 Mudança para o turno ${turno}`,
    manual: false,
    hidden: false,
    done: false,
    timestamp: Date.now(),
  });
  turnInput.value = turno + 1;
}

async function deleteSelectedLogs() {
  const checkboxes = document.querySelectorAll(".log-select:checked");
  for (const cb of checkboxes) {
    await deleteDoc(doc(eventLogColl, cb.dataset.id));
  }
}

async function toggleVisibility() {
  const checkboxes = document.querySelectorAll(".log-select:checked");
  for (const cb of checkboxes) {
    const entry = currentLogArray.find(l => l.id === cb.dataset.id);
    if (entry) {
      await updateDoc(doc(eventLogColl, cb.dataset.id), { hidden: !entry.hidden });
    }
  }
}

function filterStatusLogs() {
  const filter = document.getElementById("status-filter").value;
  document.querySelectorAll(".log-entry").forEach(entry => {
    const id = entry.querySelector(".log-select").dataset.id;
    const log = currentLogArray.find(l => l.id === id);
    if (!log) return;
    switch (filter) {
      case "all":
        entry.style.display = "flex";
        break;
      case "visible":
        entry.style.display = !log.hidden ? "flex" : "none";
        break;
      case "hidden":
        entry.style.display = log.hidden ? "flex" : "none";
        break;
      case "done":
        entry.style.display = log.done ? "flex" : "none";
        break;
      case "todo":
        entry.style.display = !log.done ? "flex" : "none";
        break;
    }
  });
}

// ---- EXPORTABLE: ADD EVENT FROM GAME SYSTEM ----
// Usage: call this from your dice system when you want to add a log entry
export async function addGameLogEntry(htmlString) {
  await addDoc(eventLogColl, {
    content: htmlString,
    manual: false,
    hidden: false,
    done: false,
    timestamp: Date.now(),
  });
}

function styleSpellActions(side) {
  const fields = ["ins", "raz", "mal", "sim"];
  fields.forEach(type => {
    const spanId = `spell_${type}-${side}`;
    const container = document.getElementById(spanId);
    if (!container) return;

    const rawText = container.textContent || "";
    // Use a mesma lógica de compostos
    const composedActions = Object.keys(keywordToAttr)
      .filter(k => k.includes(","))
      .sort((a, b) => b.length - a.length);

    let rest = rawText;
    let detected = [];

    composedActions.forEach(comp => {
      const regex = new RegExp(`\\b${comp}\\b`, "gi");
      rest = rest.replace(regex, match => {
        detected.push(match);
        return `§§${detected.length - 1}§§`;
      });
    });

    let splitArr = rest.split(/\s*,\s*/).filter(Boolean);

    splitArr = splitArr.map(item => {
      if (item.startsWith("§§") && item.endsWith("§§")) {
        const idx = parseInt(item.replace(/§§/g, ""));
        return detected[idx];
      }
      return item;
    });

    container.innerHTML = "";

    splitArr.forEach(action => {
      const typeClass = keywordToAttr[action.toUpperCase()] || type;
      const span = document.createElement("span");
      span.classList.add("action-block", typeClass, "spell-action-button");
      span.dataset.full = action;

      // Exibe tudo mesmo que tenha barra/virgula
      span.textContent = action;

      // Seleciona dropdown no clique
      span.addEventListener("click", () => {
        const dropdown = document.getElementById(`action-select-${side}`);
        const options = Array.from(dropdown.options);
        const index = options.findIndex(opt => opt.textContent.trim() === action.trim());
        if (index >= 0) {
          dropdown.selectedIndex = index;
          dropdown.dispatchEvent(new Event("change"));
        } else {
          alert(`Ação "${action}" não encontrada no dropdown.`);
        }
      });
      container.appendChild(span);
    });
  });
}


function addArenaCondition(side) {
  const condInput = document.getElementById(`cond-${side}`);
  const turnsInput = document.getElementById(`cond-turns-${side}`);
  const tagList = document.getElementById(`cond-tags-${side}`);
  const value = condInput.value.trim();
  const turns = parseInt(turnsInput.value) || 0;

  if (!value || [...tagList.children].some(tag => tag.dataset.value === value)) return;

  const displayTurns = turns < 0 ? "Concentração" : turns === 0 ? "Indefinido" : `${turns}`;

  // Find tooltip from Firebase
  const match = (window.conditionsData || []).find(c => 
    c.condition && c.condition.toLowerCase() === value.toLowerCase()
  );
  const tooltip = match
    ? `${match.cond_category || ""}: ${match.cond_description || ""}\nEFEITO: ${match.cond_effects || ""}`
    : "";

  // Build tag
  const tag = document.createElement("span");
  tag.className = "tag";
  tag.dataset.value = value;
  tag.title = tooltip;
  tag.innerHTML = `${value} (${displayTurns}) <button type="button" onclick="removeTag(this, '${side}', 'cond')">✕</button>`;
  tagList.appendChild(tag);

  condInput.value = "";
  turnsInput.value = "0";

  syncConditionsToFirebase(side);
}

// Removes a tag on a single click
window.removeTag = function(button, side, type) {
  const tag = button.parentElement;
  tag.remove();
  if (type === "cond") syncConditionsToFirebase(side);
};

// Updates Firebase with the DOM's tag list
function syncConditionsToFirebase(side) {
  const charId = document.getElementById(`char-select-${side}`).value;
  if (!charId) return;
  const tagContainer = document.getElementById(`cond-tags-${side}`);
  const tags = Array.from(tagContainer.querySelectorAll("span.tag"));
  const conditionsText = tags
    .map(tag => tag.textContent.replace(/\s*✕$/, "").trim())
    .filter(Boolean)
    .join(", ");

  // Update Firestore (async)
  const charRef = doc(db, "campaigns", "alpha", "characters_range", charId);
  updateDoc(charRef, { char_cond: conditionsText })
    .then(() => showSaveIndicator("☁️ Sincronizado"))
    .catch(error => {
      console.error("Error updating char_cond:", error);
      showSaveIndicator("❌ Erro");
    });
}
// Make function globally accessible
window.addArenaCondition = addArenaCondition;
	
function addTag(side, type) {
  const inputId = type === "cond" ? `cond-${side}` : `${type}-${side}`;
  const turnsId = type === "cond" ? `cond-turns-${side}` : `${type}-turns-${side}`;
  const tagContainer = document.getElementById(`${type}-tags-${side}`);
  const input = document.getElementById(inputId);
  const turns = parseInt(document.getElementById(turnsId)?.value || "0");

  const value = input.value.trim();
  if (!value) return;

  // Prevent duplicate
  const existingTags = tagContainer.querySelectorAll("span");
  for (const tag of existingTags) {
    if (tag.dataset.value === value) return;
  }

  // Tooltip from Firebase
  let tooltip = "";
  if (type === "cond" && typeof conditionsData !== "undefined") {
    const match = conditionsData.find(c => c.condition === value);
    tooltip = match
      ? `${match.cond_category || ''}: ${match.cond_description || ''}\nEFEITO: ${match.cond_effects || ''}`
      : "";
  }

  const span = document.createElement("span");
  span.className = "tag";
  span.dataset.value = value;
  span.title = tooltip;

  let turnLabel = "";
  if (turns === 0) turnLabel = " (Indefinido)";
  else if (turns < 0) turnLabel = " (Concentração)";
  else turnLabel = ` (${turns})`;

  span.innerHTML = `${value}${turnLabel} <button onclick="removeTag(this, '${side}', '${type}')">✕</button>`;

  tagContainer.appendChild(span);
  input.value = "";
  input.removeAttribute("data-tooltip");
  
  // Sync char_cond to Firebase if this is a condition tag
  if (type === "cond") {
    syncConditionsToFirebase(side);
  }
}

window.removeTag = function(button, side, type) {
  button.parentElement.remove();
  
  // Sync char_cond to Firebase if this is a condition tag
  if (type === "cond") {
    syncConditionsToFirebase(side);
  }
}

function updateConditionTags(side, condString) {
  const tagContainer = document.getElementById(`cond-tags-${side}`);
  tagContainer.innerHTML = "";
  const charId = document.getElementById(`char-select-${side}`).value;
  // Accept string param (if from DB) or fallback to charData
  const conds = (condString || (charData.find(c => c.id === charId)?.char_cond) || "").split(",");
  conds.map(t => t.trim()).filter(Boolean).forEach(tagText => {
    const baseName = tagText.replace(/\(.*\)$/, "").trim();
    const match = (window.conditionsData || []).find(c => c.condition === baseName);
    const tooltip = match
      ? `${match.cond_category || ""}: ${match.cond_description || ""}\nEFEITO: ${match.cond_effects || ""}`
      : "";
    const tag = document.createElement("span");
    tag.className = "tag";
    tag.title = tooltip;
    tag.dataset.value = baseName;
    tag.innerHTML = `${tagText} <button type="button" onclick="removeTag(this, '${side}', 'cond')">✕</button>`;
    tagContainer.appendChild(tag);
  });
}


	function setupLiveCharField(field, side, eventType = "input", parser = (x) => x) {
  const el = document.getElementById(`${field}-${side}`);
  if (!el) return;
  el.addEventListener(eventType, async function() {
    const charId = document.getElementById(`char-select-${side}`).value;
    // Early return if not loaded yet
    if (!charId) return;
    const value = parser(this.value);
    try {
      // Use Firestore to update the correct doc!
      await updateDoc(
        doc(db, "campaigns", "alpha", "characters_range", charId),
        { [field]: value }
      );
      showSaveIndicator("☁️ Sincronizado");
    } catch (error) {
      console.error(`Error updating ${field} for character ${charId}:`, error);
      showSaveIndicator("❌ Erro");
    }
  });
}

// Setup Firebase sync for dice amount and bonus dice fields
function setupSessionField(field, side, eventType = "input", parser = (x) => x) {
  const el = document.getElementById(`${field}-${side}`);
  if (!el) return;
  el.addEventListener(eventType, async function() {
    const value = parser(this.value);
    try {
      const sessionStateRef = doc(db, "campaigns", "alpha", "session_state", "main");
      await updateDoc(sessionStateRef, {
        [`${field}_${side}`]: value
      });
      showSaveIndicator("☁️ Sincronizado");
    } catch (error) {
      // If document doesn't exist, create it
      if (error.code === 'not-found') {
        try {
          await setDoc(sessionStateRef, {
            [`${field}_${side}`]: value
          });
          showSaveIndicator("☁️ Sincronizado");
        } catch (createError) {
          console.error(`Error creating session state for ${field}:`, createError);
          showSaveIndicator("❌ Erro");
        }
      } else {
        console.error(`Error updating ${field}:`, error);
        showSaveIndicator("❌ Erro");
      }
    }
  });
}

// Setup dice amount and bonus dice sync
["diceamount", "fixedbonus"].forEach(field => {
  setupSessionField(field, "a", "input", x => parseInt(x) || 0);
  setupSessionField(field, "b", "input", x => parseInt(x) || 0);
});


// Constrói as tabelas de spells A e B
function buildSpellsTables() {
  ["a", "b"].forEach(side => {
    const container = document.getElementById(`spells-${side}`);
    container.innerHTML = `
      <table style="width: 100%; font-size: 13px;">
        <tr style="vertical-align: top;">
          <td width="35px">NdF: <span id="spell_ndf-${side}"></span><br>Raro: <span id="spell_rare-${side}"></span></td>
          <td width="110px">
            Feitiço: <input id="spell-name-${side}" style="width: 90%;">
            <br>Obs.: <span id="spell_obs-${side}"></span>
          </td>
          <td width="43px">
            Dano: <span id="spell_dmg-${side}"></span><br>
            Dur.: <span id="spell_duration-${side}"></span><br>
            Con.: <span id="spell_concentration-${side}"></span>
          </td>
          <td width="50px">
            Efeito:<br> <span id="spell_effect-${side}"></span><br>
            Condições:<br> <span id="spell_effect_condition-${side}"></span>
          </td>
          <td width="50px">
            Efeito Extra:<br> <span id="spell_extra-${side}"></span><br>
            Condições:<br> <span id="spell_extra_condition-${side}"></span>
          </td>
          <td id="action-links-section" width="70px" class="spells-action-container">
            Ações:<br>
            <div style="display: flex; flex-wrap: wrap; gap: 6px;"><span id="spell_ins-${side}"></span><span id="spell_raz-${side}"></span><span id="spell_mal-${side}"></span><span id="spell_sim-${side}"></span></div><br>
            Counter: <span id="spell_counteraction-${side}"></span>
          </td>
        </tr>
      </table>
    `;

    setupAutocomplete(`spell-name-${side}`, side);
  });
}

// Preenche os dados de acordo com o feitiço selecionado
function populateSpellData(side) {
  const input = document.getElementById(`spell-name-${side}`);
  const name = input.value.trim();
  const spell = spellsData.find(s => s.spell_name === name);
  if (!spell) return;

  const spellNdf = parseInt(spell.spell_ndf) || 0;
  const charNdf = parseInt(document.getElementById(`char_ndf-${side}`)?.textContent.trim()) || 0;

  const diff = charNdf - spellNdf;
  const halfSmall = Math.floor(Math.abs(diff) / 2);
  const halfBig = Math.abs(diff) - halfSmall;

  const bonusToInput = diff >= 0 ? halfSmall : -halfSmall;
  const bonusToDmg = (diff === 0) ? "" : `<span style="margin-left: 6px;">${diff >= 0 ? "+" : "-"}${halfBig}</span>`;
  const showWarning = diff < 0 ? `<span style="margin-left: 6px; color: orange;">⚠️</span>` : "";

  // Preenche os campos da tabela de feitiço
  document.getElementById(`spell_ndf-${side}`).innerHTML = spell.spell_ndf + showWarning;
  document.getElementById(`spell_rare-${side}`).textContent = spell.spell_rare === "1" ? "⭐" : "";
  document.getElementById(`spell_obs-${side}`).textContent = spell.spell_obs;
  document.getElementById(`spell_dmg-${side}`).innerHTML = spell.spell_dmg + bonusToDmg;
  document.getElementById(`spell_duration-${side}`).textContent = spell.spell_duration;
  document.getElementById(`spell_concentration-${side}`).textContent = spell.spell_concentration === "1" ? "SIM" : "NÃO";
  document.getElementById(`spell_effect-${side}`).textContent = spell.spell_effect;
  document.getElementById(`spell_effect_condition-${side}`).textContent = spell.spell_effect_condition;
  document.getElementById(`spell_extra-${side}`).textContent = spell.spell_extra;
  document.getElementById(`spell_extra_condition-${side}`).textContent = spell.spell_extra_condition;
  document.getElementById(`spell_ins-${side}`).textContent = spell.spell_ins;
  document.getElementById(`spell_raz-${side}`).textContent = spell.spell_raz;
  document.getElementById(`spell_mal-${side}`).textContent = spell.spell_mal;
  document.getElementById(`spell_sim-${side}`).textContent = spell.spell_sim;
  document.getElementById(`spell_counteraction-${side}`).textContent = spell.spell_counteraction;

  // Aplica o bônus ao campo de input
  const bonusInput = document.getElementById(`fixedbonus-${side}`);
  if (bonusInput) bonusInput.value = bonusToInput;

  // Reestiliza os botões de ação
  styleSpellActions(side);
}

// Ativa autocomplete em um input
function setupAutocomplete(inputId, side) {
  const input = document.getElementById(inputId);
  input.setAttribute("list", `spells-list-${side}`);
  const datalist = document.createElement("datalist");
  datalist.id = `spells-list-${side}`;
  spellsList.forEach(spell => {
    const opt = document.createElement("option");
    opt.value = spell;
    datalist.appendChild(opt);
  });
  document.body.appendChild(datalist);

  input.addEventListener("change", () => populateSpellData(side));
}
async function loadFirebaseData() {
  try {
    // NO import or firebaseConfig/init here!
    // Fetch your collections:
    const charactersSnapshot = await getDocs(collection(db, "campaigns", "alpha", "characters_range"));
    charData = charactersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    window.charData = charData;

    const actionsSnapshot = await getDocs(collection(db, "campaigns", "alpha", "actions_range"));
    actionData = actionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    window.actionData = actionData;

    const spellsSnapshot = await getDocs(collection(db, "campaigns", "alpha", "spells_range"));
    spellsData = spellsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    spellsList = spellsData.map(s => s.spell_name);
    window.spellsData = spellsData;
    window.spellsList = spellsList;

    const conditionsSnapshot = await getDocs(collection(db, "campaigns", "alpha", "conditions_range"));
    conditionsData = conditionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    window.conditionsData = conditionsData;

    // If using conditions_range, load that instead
    // const querySnap = await getDocs(collection(db, "campaigns", "alpha", "conditions_range"));
    // conditionsData = [];
    // querySnap.forEach(doc => conditionsData.push(doc.data()));

    setupDropdowns();
    buildSpellsTables();
    setupConditionsAutocomplete("a");
    setupConditionsAutocomplete("b");
    setupCharacterListeners();
    console.log("Firebase data loaded successfully");

    // Listen for changes in the session state
    const sessionStateRef = doc(db, "campaigns", "alpha", "session_state", "main");
    onSnapshot(sessionStateRef, (doc) => {
      if (doc.exists()) {
        const data = doc.data();
        if (data.charA) {
          document.getElementById("char-select-a").value = data.charA;
        }
        if (data.charB) {
          document.getElementById("char-select-b").value = data.charB;
        }
        if (data.actionA) {
          document.getElementById("action-select-a").value = data.actionA;
        }
        if (data.actionB) {
          document.getElementById("action-select-b").value = data.actionB;
        }
        // Update dice amount and bonus dice fields
        if (data.diceamount_a !== undefined) {
          document.getElementById("diceamount-a").value = data.diceamount_a;
        }
        if (data.diceamount_b !== undefined) {
          document.getElementById("diceamount-b").value = data.diceamount_b;
        }
        if (data.fixedbonus_a !== undefined) {
          document.getElementById("fixedbonus-a").value = data.fixedbonus_a;
        }
        if (data.fixedbonus_b !== undefined) {
          document.getElementById("fixedbonus-b").value = data.fixedbonus_b;
        }
        // Trigger the change events to update the UI
        document.getElementById("char-select-a").dispatchEvent(new Event('change'));
        document.getElementById("char-select-b").dispatchEvent(new Event('change'));
        document.getElementById("action-select-a").dispatchEvent(new Event('change'));
        document.getElementById("action-select-b").dispatchEvent(new Event('change'));
      }
    });

  } catch (error) {
    console.error("Error loading Firebase data:", error);
  }
}

// --- Event Log Live Sync ---
const logQuery = query(eventLogColl, orderBy("timestamp", "desc")); // newest first

onSnapshot(logQuery, (snapshot) => {
  const container = document.getElementById("event-log-container");
  container.innerHTML = ""; // Clear log display

  snapshot.forEach(docSnap => {
    renderFirebaseLogEntry(docSnap.data());
  });
});

window.onload = loadFirebaseData;

</script>
<table border="0" cellpadding="0" cellspacing="0" class="twocell-table">
<tr>
<!-- Character A Cell -->
<td valign="top">
<div class="char-block" id="char-a">
<!-- Character Info Table -->
<center><table border="1" cellpadding="10" name="Character-A" style="border-collapse:collapse; table-layout:fixed; width:95%; background-color: #151515; border-radius: 4px;">
<colgroup>
<col style="width:150px;"/>
<col style="width:140px;"/>
<col style="width:190px;"/>
<col style="width:70px;"/>
<col style="width:140px;"/>
<col style="width:100px;"/>
</colgroup>
<tr>
<td id="char_avatar-a" rowspan="2"></td>
<td colspan="2" height="60"><select class="char-name" id="char-select-a"></select>
<div style="text-align: right">(<span class="minititle" id="char_player-a"></span>)</div></td>
<td colspan="3">
<div style="display: flex; gap: 18px; align-items: flex-start; width: 100%;">
<!-- HP -->
<div style="width: 155px;">
<div>
<div style="text-align: right; width: 134px;">
        🩸<input class="cond-obs" id="char_hp-a" style="width:30px; font-size:15px; padding:2px; text-align:center;" type="number" min="0"/> /
        <span class="text-hp" id="char_maxhp-a"></span>
</div>
</div>
<input class="slider-top" id="char_hp_range-a" style="width: 135px; display: block;" type="range"/>
</div>
<!-- Energy -->
<div style="width: 155px;">
<div>
<div style="text-align: right; width: 134px;">
                  ⚡<input class="cond-obs" id="char_energy-a" style="width:30px; font-size:15px; padding:2px; text-align:center;" type="number" min="0"/> /
                  <span class="text-energy" id="char_maxenergy-a"></span>
</div>
</div>
<input class="slider-top" id="char_energy_range-a" style="width: 135px; display: block;" type="range"/>
</div>
</div>
</td>
</tr>
<tr>
<td colspan="3" height="110" style="text-align: center; vertical-align: top;">
<div style="display: flex; gap: 10px; padding-left: 12px;">
<table border="1"><tr><td class="atr-num-ins" height="60" id="char_ins-a" width="70"></td></tr><tr><td class="atr">🔥 INS</td></tr></table>
<table border="1"><tr><td class="atr-num-sim" height="60" id="char_sim-a" width="70"></td></tr><tr><td class="atr">❤️ SIM</td></tr></table>
<table border="1"><tr><td class="atr-num-raz" height="60" id="char_raz-a" width="70"></td></tr><tr><td class="atr">⚙️ RAZ</td></tr></table>
<table border="1"><tr><td class="atr-num-mal" height="60" id="char_mal-a" width="70"></td></tr><tr><td class="atr">𖦹 MAL</td></tr></table>
</div>
</td>
<td rowspan="2" style="text-align: center; text-align: center; vertical-align: top;">
<div class="frame"><span class="title">BÔNUS</span><br/>
<span class="action-variable" id="char_bonus1-a"></span><br/>
<span class="action-variable" id="char_bonus2-a"></span><br/>
<span class="action-variable" id="char_bonus3-a"></span><br/>
<span class="action-variable" id="char_bonus4-a"></span><br/>
<span class="action-variable" id="char_bonus5-a"></span><br/>
<span class="action-variable" id="char_bonus6-a"></span><br/></div><br/>
<div class="frame"><span class="title">DEDUÇÕES</span><br/>
<span class="action-variable" id="char_deduc1-a"></span><br/>
<span class="action-variable" id="char_deduc2-a"></span><br/>
<span class="action-variable" id="char_deduc3-a"></span></div>
</td>
<td rowspan="2" style="vertical-align: top;">
<div style="display: flex; flex-direction: column; align-items: center; ">
<table border="1"><tr><td class="atr-num-none" height="40" id="char_por-a" width="50"></td></tr><tr><td class="atr">POR</td></tr></table>
<table border="1"><tr><td class="atr-num-none" height="40" id="char_ndf-a" width="50"></td></tr><tr><td class="atr">NdF</td></tr></table><br/>
<span class="atr">Agi <span class="title" id="char_agi-a" style="text-align: left;"></span></span>
<span class="atr">Per <span class="title" id="char_passiveperc-a" style="text-align: left;"></span></span>
<span class="atr">✦ <input class="cond-obs" data-tooltip="Pontos de Naração" id="char_narrativepoints-a" placeholder="0" style="width:15px; font-size:15px; padding:4px;" type="text"/></span><br/>
<div style="display: flex; gap: 4px; align-items: center;">
<button class="button" id="inc-btn-a">+</button>
<button class="button" id="dec-btn-a">−</button>
</div><br/>
<button class="button" id="obs-toggle-a">Obs.</button>
</div>
</td>
</tr>
<tr>
<td colspan="2">
<div class="slider-set" style="width: 300px;">
<div class="separated"><span class="minititle">Medo</span><span>Raiva</span></div>
<div class="slider-container">
<input class="slider" id="char_fear_anger-a" max="3" min="-3" step="1" type="range" value="0"/>
</div>
<div class="separated"><span>Desconfiança</span><span>Afeto</span></div>
<div class="slider-container">
<input class="slider" id="char_distrust_trust-a" max="3" min="-3" step="1" type="range" value="0"/>
</div>
<div class="separated"><span>Estresse</span><span>Calma</span></div>
<div class="slider-container">
<input class="slider" id="char_stress_calm-a" max="3" min="-3" step="1" type="range" value="0"/>
</div>
<div class="separated"><span>Culpa</span><span>Satisfação</span></div>
<div class="slider-container">
<input class="slider" id="char_guilt_satisf-a" max="3" min="-3" step="1" type="range" value="0"/>
</div>
</div> </td>
<td colspan="2" style="text-align: center; vertical-align: top;">
<div id="input-container-a" style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
<span class="title">CONDIÇÕES</span>
<div style="display: flex; gap: 6px; align-items: center;">
<input id="cond-a" placeholder="Nome da condição" style="width: 140px; padding: 4px; font-size: 14px;" type="text"/>
<input id="cond-turns-a" placeholder="Turnos" style="width: 60px; padding: 4px; font-size: 14px;" type="number"/>
<button onclick="addArenaCondition('a')">+</button>
</div>
<div class="tag-list" id="cond-tags-a"></div>
</div>
</td>
</tr>
<tr style="border-top-style: solid; border-top-color: #222;">
<td colspan="6">
<div id="obs-field-a" style="display: none; margin-top: 6px;">
<textarea id="char_obs-a" placeholder="Adicione uma observação e pressione Enter..." rows="3" style="width: 95%; font-size: 15px; padding: 5px;"></textarea>
</div>
</td>
</tr>
</table></center>
<!-- Action Roller goes here! -->
<center><table class="roll-section" id="roll-section-a" style="width: 95%;">
<tr>
<td style="width:600px;">
<span class="roll-formula sub-variable" id="action_formula_lit-a"></span>
</td>
<td rowspan="2">
<button class="button" id="rollalldice-a">Rolar!</button>
</td>
<td>
<span id="roll_result-a"></span>
</td>
</tr>
<tr>
<td class="dice-rolling-line" id="dice-rolling-line">
<div class="back-variable dice-select-block" id="selected_att-block-a">
<span id="selected_att-a"></span>
<span class="sub-variable"><span id="selected_att_label-a"></span>
</span>
</div>
        +
        <div class="back-variable dice-select-block" id="dice-select-block-a">
<input id="diceamount-a" min="1" style="width:50px; font-size: 16px; text-align: center;" type="number" value="1">
<span id="diceamount_label-a"></span>
<span class="sub-variable">DADOS</span>
</input></div>
        +
        <div class="back-variable dice-select-block" id="fixedbonus-block-a">
<input id="fixedbonus-a" style="width:50px; font-size: 16px; text-align: center;" type="number" value="0">
<span id="fixedbonus_label-a"></span>
<span class="sub-variable">BÔNUS FIXO</span>
</input></div>
        +
        <span id="specialdice_controls-a" style="display: flex; align-items: center; gap: 4px;">
<span id="specialdice_area-a"></span>
<button class="button" id="add-special-a" title="Novo Dado" type="button">✦</button>
</span>
<span style="opacity: 20%">=
        <span id="partialresult-a"></span></span>
</td>
<td>
<span id="roll_breakdown-a"></span>
</td>
</tr>
</table></center>
<span id="specialdice-a" style="display:none;"></span>
<span id="partialresult_log-a" style="display:none;"></span>
<!-- Action Info Table -->
<center><table border="1" cellpadding="10" cellspacing="0" class="back-variable" id="back-div-a" style="text-align: center; width:95%; margin-top: 12px; border-radius: 4px;">
<tr height="60">
<td rowspan="7" width="240"><span class="cover-img" id="img_action-a"></span></td>
<td width="60"><div style="display: inline-flex; gap: 5px;"><span class="img" id="att_img-a"></span> <span class="text-variable" id="selected_att_name-a"></span></div></td>
<td width="60"><span class="text-variable" id="action_energy-a"></span></td>
<td width="60"><span class="text-variable-emoji" id="action_type1-a"></span></td>
<td width="60"><span class="text-variable-emoji" id="action_type2-a"></span></td>
<td width="60"><span class="text-variable-emoji" id="action_type3-a"></span></td>
<td width="60"><span class="text-variable-emoji" id="action_group_possib-a"></span></td>
<td width="90"><span class="sub-variable" id="action_type-a" style="font-size: 14px; text-transform: uppercase;"></span></td>
</tr>
<tr height="70">
<td class="light-div" colspan="6" id="light-div-action-a"><select class="title-variable" id="action-select-a"></select></td>
<td class="light-div right-gap" id="light-div-symbol-a" style="margin-left: 5px;"><span class="text-variable" id="img_action_type-a"></span></td>
</tr>
<tr height="40">
<td class="dark-div" colspan="3" id="dark-div-1-a"><span class="sub-variable" id="cell-contra-a">ROLA CONTRA</span></td>
<td class="dark-div" colspan="2" id="dark-div-2-a"><span class="sub-variable" id="cell-bonus-se-a">BÔNUS SE</span></td>
<td class="dark-div right-gap" colspan="2" id="dark-div-3-a"><span class="sub-variable" id="cell-adv-bonus-se-a">ADVERSÁRIO TEM BÔNUS SE</span></td>
</tr>
<tr height="50">
<td class="dark-div" colspan="3" id="dark-div-4-a"><span id="counter-a"></span></td>
<td class="dark-div" colspan="2" id="dark-div-5-a"><span class="strong-variable" id="has_bonus-a"></span></td>
<td class="dark-div right-gap" colspan="2" id="dark-div-6-a"><span class="strong-variable" id="opp_has_bonus-a"></span></td>
</tr>
<tr height="90">
<td class="light-div right-gap" colspan="7" id="light-div-desc-a" style="padding: 20px; !important;"><span class="descr-variable" id="action_description-a"></span></td>
</tr>
<tr height="80">
<td class="dark-div right-gap right-gap bottom-gap" colspan="7" id="dark-div-7-a" style="padding: 20px; !important;"><span class="sub-variable" id="action_condition-a" style="font-size: 14px; text-transform: uppercase;"></span></td>
</tr>
</table></center>
</div>
</td>
<!-- Character B Cell (everything repeated, with only interactive/output ids made unique with -b) -->
<td valign="top">
<div class="char-block" id="char-b">
<!-- Character Info Table -->
<table border="1" cellpadding="10" name="Character-B" style="border-collapse:collapse; table-layout:fixed; width:95%; background-color: #151515; border-radius: 4px;">
<colgroup>
<col style="width:150px;"/>
<col style="width:140px;"/>
<col style="width:190px;"/>
<col style="width:70px;"/>
<col style="width:140px;"/>
<col style="width:100px;"/>
</colgroup>
<tr>
<td id="char_avatar-b" rowspan="2"></td>
<td colspan="2" height="60"><select class="char-name" id="char-select-b"></select>
<div style="text-align: right">(<span class="minititle" id="char_player-b"></span>)</div></td>
<td colspan="3">
<div style="display: flex; gap: 18px; align-items: flex-start; width: 100%;">
<div style="width: 155px;">
<div>
<div style="text-align: right; width: 134px;">
                  🩸<input class="cond-obs" id="char_hp-b" style="width:30px; font-size:15px; padding:2px; text-align:center;" type="number" min="0"/> /
                  <span class="text-hp" id="char_maxhp-b"></span>
</div>
</div>
<input class="slider-top" id="char_hp_range-b" style="width: 135px; display: block;" type="range"/>
</div>
<div style="width: 155px;">
<div>
<div style="text-align: right; width: 134px;">
                  ⚡<input class="cond-obs" id="char_energy-b" style="width:30px; font-size:15px; padding:2px; text-align:center;" type="number" min="0"/> /
                  <span class="text-energy" id="char_maxenergy-b"></span>
</div>
</div>
<input class="slider-top" id="char_energy_range-b" style="width: 135px; display: block;" type="range"/>
</div>
</div>
</td>
</tr>
<tr>
<td colspan="3" height="110" style="text-align: center; vertical-align: top;">
<div style="display: flex; gap: 10px; padding-left: 12px;">
<table border="1"><tr><td class="atr-num-ins" height="60" id="char_ins-b" width="70"></td></tr><tr><td class="atr">🔥 INS</td></tr></table>
<table border="1"><tr><td class="atr-num-sim" height="60" id="char_sim-b" width="70"></td></tr><tr><td class="atr">❤️ SIM</td></tr></table>
<table border="1"><tr><td class="atr-num-raz" height="60" id="char_raz-b" width="70"></td></tr><tr><td class="atr">⚙️ RAZ</td></tr></table>
<table border="1"><tr><td class="atr-num-mal" height="60" id="char_mal-b" width="70"></td></tr><tr><td class="atr">𖦹 MAL</td></tr></table>
</div>
</td>
<td rowspan="2" style="text-align: center; vertical-align: top;">
<div class="frame"><span class="title">BÔNUS</span><br/>
<span class="action-variable" id="char_bonus1-b"></span><br/>
<span class="action-variable" id="char_bonus2-b"></span><br/>
<span class="action-variable" id="char_bonus3-b"></span><br/>
<span class="action-variable" id="char_bonus4-b"></span><br/>
<span class="action-variable" id="char_bonus5-b"></span><br/>
<span class="action-variable" id="char_bonus6-b"></span><br/></div><br/>
<div class="frame"><span class="title">DEDUÇÕES</span><br/>
<span class="action-variable" id="char_deduc1-b"></span><br/>
<span class="action-variable" id="char_deduc2-b"></span><br/>
<span class="action-variable" id="char_deduc3-b"></span></div>
</td>
<td rowspan="2" style="vertical-align: top;">
<div style="display: flex; flex-direction: column; align-items: center;">
<table border="1"><tr><td class="atr-num-none" height="40" id="char_por-b" width="50"></td></tr><tr><td class="atr">POR</td></tr></table>
<table border="1"><tr><td class="atr-num-none" height="40" id="char_ndf-b" width="50"></td></tr><tr><td class="atr">NdF</td></tr></table><br/>
<span class="atr">Agi <span class="title" id="char_agi-b" style="text-align: left;"></span></span>
<span class="atr">Per <span class="title" id="char_passiveperc-b" style="text-align: left;"></span></span>
<span class="atr">✦ <input class="cond-obs" data-tooltip="Pontos de Naração" id="char_narrativepoints-b" placeholder="0" style="width:15px; font-size:15px; padding:4px;" type="text"/></span><br/>
<div style="display: flex; gap: 4px; align-items: center;">
<button class="button" id="inc-btn-b">+</button>
<button class="button" id="dec-btn-b">−</button>
</div><br/>
<button class="button" id="obs-toggle-b">Obs.</button>
</div>
</td>
</tr>
<tr>
<td colspan="2">
<div class="slider-set" style="width: 300px;">
<div class="separated"><span class="minititle">Medo</span><span>Raiva</span></div>
<div class="slider-container">
<input class="slider" id="char_fear_anger-b" max="3" min="-3" step="1" type="range" value="0"/>
</div>
<div class="separated"><span>Desconfiança</span><span>Afeto</span></div>
<div class="slider-container">
<input class="slider" id="char_distrust_trust-b" max="3" min="-3" step="1" type="range" value="0"/>
</div>
<div class="separated"><span>Estresse</span><span>Calma</span></div>
<div class="slider-container">
<input class="slider" id="char_stress_calm-b" max="3" min="-3" step="1" type="range" value="0"/>
</div>
<div class="separated"><span>Culpa</span><span>Satisfação</span></div>
<div class="slider-container">
<input class="slider" id="char_guilt_satisf-b" max="3" min="-3" step="1" type="range" value="0"/>
</div>
</div>
</td>
<td colspan="2" style="text-align: center; vertical-align: top;">
<div id="input-container-b" style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
<span class="title">CONDIÇÕES</span>
<div style="display: flex; gap: 6px; align-items: center;">
<input class="cond-obs" id="cond-b" placeholder="Nome da condição" style="width: 140px; padding: 4px; font-size: 14px;" type="text"/>
<input id="cond-turns-b" placeholder="Turnos" style="width: 60px; padding: 4px; font-size: 14px;" type="number"/>
<button onclick="addArenaCondition('b')">+</button>
</div>
<div class="tag-list" id="cond-tags-b"></div>
</div>
</td>
</tr>
<tr style="border-top-style: solid; border-top-color: #222;">
<td colspan="6">
<div id="obs-field-b" style="display: none; margin-top: 6px;">
<textarea id="char_obs-b" placeholder="Adicione uma observação e pressione Enter..." rows="3" style="width: 95%; font-size: 15px; padding: 5px;"></textarea>
</div>
</td>
</tr>
</table>
<!-- Action Roller for B -->
<table class="roll-section" id="roll-section-b" style="width: 95%;">
<tr>
<td style="width:600px;">
<span class="roll-formula sub-variable" id="action_formula_lit-b"></span>
</td>
<td rowspan="2">
<button class="button" id="rollalldice-b">Rolar!</button>
</td>
<td>
<span id="roll_result-b"></span>
</td>
</tr>
<tr>
<td class="dice-rolling-line" id="dice-rolling-line-b">
<div class="back-variable dice-select-block" id="selected_att-block-b">
<span id="selected_att-b"></span>
<span class="sub-variable"><span id="selected_att_label-b"></span></span>
</div>
      +
      <div class="back-variable dice-select-block" id="dice-select-block-b">
<input id="diceamount-b" min="1" style="width:50px; font-size: 16px; text-align: center;" type="number" value="1">
<span id="diceamount_label-b"></span>
<span class="sub-variable">DADOS</span>
</input></div>
      +
      <div class="back-variable dice-select-block" id="fixedbonus-block-b">
<input id="fixedbonus-b" style="width:50px; font-size: 16px; text-align: center;" type="number" value="0">
<span id="fixedbonus_label-b"></span>
<span class="sub-variable">BÔNUS FIXO</span>
</input></div>
      +
      <span id="specialdice_controls-b" style="display: flex; align-items: center; gap: 4px;">
<span id="specialdice_area-b"></span>
<button class="button" id="add-special-b" title="Novo Dado" type="button">✦</button>
</span>
<span style="opacity: 20%">=
        <span id="partialresult-b"></span></span>
</td>
<td>
<span id="roll_breakdown-b"></span>
</td>
</tr>
</table>
<span id="specialdice-b" style="display:none;"></span>
<span id="partialresult_log-b" style="display:none;"></span>
<!-- Action B Info Table -->
<table border="1" cellpadding="10" cellspacing="0" class="back-variable" id="back-div-b" style="text-align: center; width:95%; margin-top: 12px; border-radius: 4px;">
<tr height="60">
<td rowspan="7" width="240"><span class="cover-img" id="img_action-b"></span></td>
<td width="60"><div style="display: inline-flex; gap: 5px;"><span class="img" id="att_img-b"></span> <span class="text-variable" id="selected_att_name-b"></span></div></td>
<td width="60"><span class="text-variable" id="action_energy-b"></span></td>
<td width="60"><span class="text-variable-emoji" id="action_type1-b"></span></td>
<td width="60"><span class="text-variable-emoji" id="action_type2-b"></span></td>
<td width="60"><span class="text-variable-emoji" id="action_type3-b"></span></td>
<td width="60"><span class="text-variable-emoji" id="action_group_possib-b"></span></td>
<td width="90"><span class="sub-variable" id="action_type-b" style="font-size: 14px; text-transform: uppercase;"></span></td>
</tr>
<tr height="70">
<td class="light-div" colspan="6" id="light-div-action-b"><select class="title-variable" id="action-select-b"></select></td>
<td class="light-div right-gap" id="light-div-symbol-b" style="margin-left: 5px;"><span class="text-variable" id="img_action_type-b"></span></td>
</tr>
<tr height="40">
<td class="dark-div" colspan="3" id="dark-div-1-b"><span class="sub-variable" id="cell-contra-b">ROLA CONTRA</span></td>
<td class="dark-div" colspan="2" id="dark-div-2-b"><span class="sub-variable" id="cell-bonus-se-b">BÔNUS SE</span></td>
<td class="dark-div right-gap" colspan="2" id="dark-div-3-b"><span class="sub-variable" id="cell-adv-bonus-se-b">ADVERSÁRIO TEM BÔNUS SE</span></td>
</tr>
<tr height="50">
<td class="dark-div" colspan="3" id="dark-div-4-b"><span id="counter-b"></span></td>
<td class="dark-div" colspan="2" id="dark-div-5-b"><span class="strong-variable" id="has_bonus-b"></span></td>
<td class="dark-div right-gap" colspan="2" id="dark-div-6-b"><span class="strong-variable" id="opp_has_bonus-b"></span></td>
</tr>
<tr height="90">
<td class="light-div right-gap" colspan="7" id="light-div-desc-b" style="padding: 20px;"><span class="descr-variable" id="action_description-b"></span></td>
</tr>
<tr height="80">
<td class="dark-div right-gap bottom-gap" colspan="7" id="dark-div-7-b" style="padding: 20px;"><span class="sub-variable" id="action_condition-b" style="font-size: 14px; text-transform: uppercase;"></span></td>
</tr>
</table>
</div>
</td>
</tr>
</table>
<h2>Log de Rolagens</h2>
<div id="event-log-toolbar">
<button class="button" onclick="deleteSelectedLogs()">🗑️ Excluir</button>
<button class="button" onclick="toggleVisibility()">👁️ Ocultar Selecionados</button>
<select class="button" id="status-filter" onchange="filterStatusLogs()">
<option value="all">🔄 Todos</option>
<option value="visible">👁️ Visíveis</option>
<option value="hidden">🙈 Ocultos</option>
<option value="done">✅ Feitos</option>
<option value="todo">📝 A Fazer</option>
</select>
<button class="button" onclick="addManualLog()">➕ Linha Manual</button>
<button class="button" onclick="addTurnChange()">🔁 Mudança de Turno</button>
  Turno atual: <input id="current-turn" min="1" style="width: 60px;" type="number" value="1"/>
</div>
<div id="event-log-container"></div>
<!-- END -->
</body>
</html>
